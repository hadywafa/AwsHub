# üîê **Application Load Balancer ‚Äì Authenticate Users via Cognito or OIDC**

Amazon **Application Load Balancer (ALB)** isn't just a traffic distributor ‚Äî it can **authenticate users** before requests reach your backend (like ECS, EC2, or Lambda). This is achieved by offloading the authentication logic from your app to the **ALB listener** using **Cognito** or **OIDC-compliant identity providers**.

---

## ‚öôÔ∏è **How ALB Authentication Works**

When a user makes a request to an HTTPS ALB:

1. **HTTPS Listener** intercepts the request.
2. If **authentication rules** are enabled, it:

   - Redirects unauthenticated users to
     - **1Ô∏è‚É£ Cognito Hosted UI** or
     - **2Ô∏è‚É£ OIDC Auth Endpoint**.
   - After authentication, receives a token (ID token or access token).

3. The user is then forwarded to the backend **only if authentication succeeds**.

### üîë Benefits

| Feature                    | Explanation                                                               |
| -------------------------- | ------------------------------------------------------------------------- |
| üîê Built-in Auth Layer     | ALB authenticates before backend, offloading auth logic from your app.    |
| üåê Supports Cognito & OIDC | Use AWS Cognito, Google, Facebook, or any OpenID Connect (OIDC) provider. |
| ‚ö° Transparent to Backend  | Backend receives already authenticated traffic (JWT claims if needed).    |
| üîÅ Built-in Redirection    | Automatically handles login flows and callback redirects.                 |

---

## 1Ô∏è‚É£ **ALB with Amazon Cognito Integration**

<div style="text-align: center;">
    <img src="images/alb-cognito-integration.png" alt="alb-cognito-integration" style="border-radius: 10px; width: 60%;">
</div>

---

### ‚úÖ **Requirements:**

- A **Cognito User Pool** and **App Client**.
- Hosted UI must be configured.
- App Client must return **ID tokens**.

### üõ†Ô∏è **ALB Listener Setup:**

- **Protocol**: HTTPS
- **Default Actions**:

  1. **Authenticate** with Cognito
  2. **Forward** to target group (ECS/EC2/Lambda)

### üîÅ **Authentication Flow with Cognito:**

---

<div style="text-align: center;">
    <img src="images/alb-cognito-integration-workflow.png"
         alt="alb-cognito-integration-workflow"
         style="border-radius: 10px; width: 90%;">
</div>

---

## 2Ô∏è‚É£ **ALB with OIDC Integration (e.g., Auth0, Okta)**

<div style="text-align: center;">
    <img src="images/alb-oidc-integration.png" alt="alb-oidc-integration" style="border-radius: 10px; width: 60%;">
</div>

---

### ‚úÖ **Required Fields:**

- **Issuer URL**
- **Authorization Endpoint**
- **Token Endpoint**
- **User Info Endpoint**
- **Client ID and Secret**

ALB will use these endpoints to:

- Redirect for login
- Exchange auth code for tokens
- Retrieve user claims

---

## ‚ö†Ô∏è **Listener Rule: `authenticate-cognito` or `authenticate-oidc`**

- **Condition**: When a path (e.g., `/api/*`) is accessed
- **Action**:

  - `authenticate-cognito` or `authenticate-oidc`
  - Then `forward` to target group

### ‚öôÔ∏è **Advanced Options:**

| Setting                    | Description                                      |
| -------------------------- | ------------------------------------------------ |
| `OnUnauthenticatedRequest` | `authenticate` (default), `deny`, or `allow`     |
| Token TTLs                 | Customize session TTL, idle timeout, and max age |
| Scope                      | Specify OIDC scopes to be returned               |

---

## üîê **Use Cases**

| Use Case                            | How ALB Helps                                                             |
| ----------------------------------- | ------------------------------------------------------------------------- |
| Secure public-facing web apps       | No backend change required, plug-in identity protection.                  |
| External user login (social/OIDC)   | Integrate with Cognito for Google, Facebook, or with external IdP (OIDC). |
| Multi-tenant apps                   | Use JWT claims in the token to route or filter requests.                  |
| Internal authentication enforcement | Restrict access via Cognito User Pool MFA or corporate IdP with SAML.     |

---

## ‚úçüèª **Example: ALB + Cognito + ECS**

<div style="text-align: center;">
    <img src="images/alb-cognito-ecs-example.png"
         alt="alb-cognito-ecs-example"
         style="border-radius: 10px; width: 90%;">
</div>

---

### üîÑ **Step-by-Step Flow:**

1. User hits ALB ‚Üí `/api/data`
2. ALB redirects user to Cognito login page
3. After successful login, Cognito sends JWT
4. ALB forwards request to ECS service with the JWT
5. ECS API validates token or simply trusts ALB

---

## üõ†Ô∏è **Security Considerations**

| Concern          | Recommendation                                          |
| ---------------- | ------------------------------------------------------- |
| Token validation | ALB doesn‚Äôt inspect token content ‚Äî app must if needed. |
| Custom domains   | Use **ACM in us-east-1** for custom Cognito domain.     |
| HTTPS required   | ALB authentication **must** be used on port 443.        |

---

## üß™ **Testing Tips**

- Enable **CloudWatch Logs** to view auth failures or token issues.
- Use tools like **JWT.io** to inspect token content returned by Cognito.
- Monitor login flows with **Cognito Analytics** or **ALB access logs**.

---

## üöÄ Summary

Application Load Balancer authentication is a **simple yet powerful** way to protect your APIs and applications without rewriting backend code.

- ‚úÖ Supports both **Cognito** and **OIDC**
- ‚úÖ Easily integrates with **ECS, EC2, or Lambda**
- ‚úÖ Shifts auth logic to the ALB for simplicity and scalability
- ‚úÖ Reduces attack surface and handles login redirects for you
