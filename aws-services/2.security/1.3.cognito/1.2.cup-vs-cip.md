# ğŸ” **AWS Cognito: User Pools & Identity Pools Architecture & Flow**

<div style="text-align: center;">
  <img src="images/aws-cognito-diagram.png" alt="AWS Cognito Diagram" style="border-radius: 20px; width: 80%;" />
</div>

---

AWS Cognito provides **two main services**:

| **Component**     | **Purpose**                                                                                           | **Use Case**                                              |
| ----------------- | ----------------------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| **User Pool**     | Manages **user authentication** (Sign-in, Sign-up, MFA, OAuth, Social Logins)                         | Secure authentication for applications                    |
| **Identity Pool** | Provides **temporary AWS credentials** to users from **any identity provider (including User Pools)** | Secure access to AWS services (S3, DynamoDB, API Gateway) |

> ğŸ’¡ **They can be used separately or together!**

---

## **1ï¸âƒ£ AWS Cognito User Pool Architecture & Flow**

### **ğŸ“Œ What is a User Pool?**

A **User Pool** is an authentication directory that provides:

- âœ… **Sign-in & Sign-up (Email, Username, Phone)**
- âœ… **OAuth2, OpenID Connect, SAML Authentication (Google, Facebook, Apple, Custom OAuth)**
- âœ… **Multi-Factor Authentication (MFA)**
- âœ… **JWT Tokens (ID Token, Access Token, Refresh Token)**

---

### **ğŸ› ï¸ How to Configure a Cognito User Pool in AWS**

1. **Go to AWS Cognito Console** â†’ Click **Create User Pool**.
2. **Sign-in Options**:
   - Choose **Username, Email, or Phone Number**.
   - Enable **Multi-Factor Authentication (MFA)** if required.
3. **OAuth2 / Federated Authentication**:
   - Navigate to **App Integration** â†’ **Identity Providers**.
   - Configure **Google, Facebook, Apple, or Custom OAuth Provider**.
4. **Enable Hosted UI for Authentication**.
5. **Create App Clients**:
   - **Disable Client Secret** for web/mobile apps.
   - Enable **ID, Access, and Refresh Tokens**.
6. **Save & Copy User Pool ID & App Client ID**.

---

### **ğŸ–¼ï¸ Workflow**

<div style="text-align: center;">
    <img src="images/cognito-user-pool.gif" alt="cognito-user-pool.gif" style="border-radius: 20px; width: 80%;" >
</div>

---

```mermaid
sequenceDiagram
    autonumber
    participant User as User
    participant Browser as User's Web Browser
    participant App as Web/Mobile App
    participant Cognito as AWS Cognito User Pool
    participant IdP as External Identity Provider (Google, Facebook, OAuth2)
    participant API as Protected Backend API

    User->>Browser: 1ï¸âƒ£ Navigate to App Login Page
    Browser->>App: 2ï¸âƒ£ Request Login UI
    App->>Cognito: 3ï¸âƒ£ Redirect to Cognito Hosted UI

    alt Direct Cognito Authentication (Using User Pool Directory)
        Browser->>Cognito: 4ï¸âƒ£ Enter Username/Password
        Cognito->>Cognito: 5ï¸âƒ£ Authenticate User (Only for Cognito Directory)
    else Federated Authentication (Google, Facebook, Custom OAuth)
        Cognito->>IdP: 4ï¸âƒ£ Redirect to External IdP (Google, Facebook, OAuth2)
        IdP->>User: 5ï¸âƒ£ Prompt for Credentials
        User->>IdP: 6ï¸âƒ£ Submit Credentials
        IdP->>Cognito: 7ï¸âƒ£ Return OAuth2 Access Token
        Cognito->>Cognito: 8ï¸âƒ£ Validate Token & Create Cognito User
    end

    Cognito->>Browser: 9ï¸âƒ£ Return ID & Access Token (JWT)
    Browser->>App: ğŸ”Ÿ Pass Tokens to App
    App->>API: 11 Send API Request with Access Token
    API->>Cognito: 12 Validate Access Token
    Cognito->>API: 13 Token Valid / Expired Response
    API->>App: 14 Return Protected Data
    App->>User: 15 Display User Data
```

---

## **2ï¸âƒ£ AWS Cognito Identity Pool Architecture & Flow**

### **ğŸ“Œ What is an Identity Pool?**

An **Identity Pool** is NOT an authentication service! Instead, it:

- âœ… **Exchanges identity provider tokens (Google, Facebook, SAML, etc.) for AWS credentials**
- âœ… **Maps users to IAM roles & grants AWS permissions**
- âœ… **Does NOT authenticate users but relies on federated identities**

---

### **ğŸ–¼ï¸ Workflow**

<div style="text-align: center;">
    <img src="images/cognito-identity-pool.gif" alt="cognito-identity-pool.gif" style="border-radius: 20px; width: 80%;">
</div>

---

```mermaid
sequenceDiagram
    autonumber
    participant User as User
    participant Browser as User's Web Browser
    participant App as Web/Mobile App
    participant IdP as External Identity Provider (Google, Facebook, OAuth2)
    participant CognitoIdentity as Cognito Identity Pool
    participant STS as AWS Security Token Service (STS)
    participant AWS as AWS Resource (S3, DynamoDB, API Gateway)

    User->>Browser: 1ï¸âƒ£ Navigate to App
    Browser->>App: 2ï¸âƒ£ Request Home Page
    App->>IdP: 3ï¸âƒ£ Sign-in via External IdP (Google, Facebook, OAuth2)
    IdP->>User: 4ï¸âƒ£ Prompt for Credentials
    User->>IdP: 5ï¸âƒ£ Submit Credentials
    IdP->>App: 6ï¸âƒ£ Return OAuth2 Access Token

    App->>CognitoIdentity: 7ï¸âƒ£ Exchange Token for AWS Credentials
    CognitoIdentity->>STS: 8ï¸âƒ£ Request Temporary AWS Credentials
    STS->>CognitoIdentity: 9ï¸âƒ£ Return AWS Credentials
    CognitoIdentity->>App: ğŸ”Ÿ Send Temporary AWS Credentials

    App->>AWS: 11 Access AWS Resources with Temporary Credentials
    AWS->>App: 12 Return Data
    App->>User: 13 Display Data
```

---

## **3ï¸âƒ£ Using Cognito User Pool & Identity Pool Together**

### ğŸ“Œ **Why Combine Both?**

- âœ” **User Pools handle authentication** (OAuth, Social, Email/Password).
- âœ” **Identity Pools handle AWS IAM role management**.
- âœ” **Prevents redundant identity federation configuration**.

---

### **ğŸ–¼ï¸ Workflow**

<div style="text-align: center;">
    <img src="images/cognito-user-pool-with-identity-pool.gif" alt="cognito-user-pool-with-identity-pool.gif" style="border-radius: 20px; width: 80%;">
</div>

---

```mermaid
sequenceDiagram
    autonumber
    participant User as User
    participant Browser as User's Web Browser
    participant App as Web/Mobile App
    participant CognitoUser as Cognito User Pool (Authentication)
    participant CognitoIdentity as Cognito Identity Pool (Authorization)
    participant STS as AWS Security Token Service (STS)
    participant AWS as AWS Resource (S3, DynamoDB, API Gateway)

    User->>Browser: 1ï¸âƒ£ Navigate to App
    Browser->>App: 2ï¸âƒ£ Request Home Page
    App->>CognitoUser: 3ï¸âƒ£ Sign-in via Cognito (Username/Password or OAuth)
    CognitoUser->>User: 4ï¸âƒ£ Return ID Token

    User->>App: 5ï¸âƒ£ Pass ID Token
    App->>CognitoIdentity: 6ï¸âƒ£ Exchange ID Token for AWS Credentials
    CognitoIdentity->>STS: 7ï¸âƒ£ Request Temporary AWS Credentials
    STS->>CognitoIdentity: 8ï¸âƒ£ Return AWS Credentials
    CognitoIdentity->>App: 9ï¸âƒ£ Send Temporary AWS Credentials

    App->>AWS: ğŸ”Ÿ Access AWS Resources with Temporary Credentials
    AWS->>App: 11 Return Data
    App->>User: 12 Display Data
```

---

## ğŸ† **Final Thoughts**

AWS Cognito correctly separates:

- âœ” **Authentication (User Pools - OAuth, Social, SAML, Custom Login)**
- âœ” **Authorization (Identity Pools - IAM Role Mapping, AWS Access)**
- âœ” **Using them together simplifies AWS permissions & access control**.

ğŸš€ **Best Practice:**

- **Use User Pools for authentication**.
- **Use Identity Pools for AWS access**.
- **Avoid reconfiguring federated login in both placesâ€”use User Pools for identity management!**
