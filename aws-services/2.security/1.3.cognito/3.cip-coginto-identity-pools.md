# ğŸ§  **Cognito Identity Pools (CIP) â€“ Federated Access to AWS Services**

Cognito **Identity Pools** enable **federated identities** to obtain **temporary AWS credentials** and access AWS services **securely and directly** from client apps â€” **without managing permanent IAM credentials**.

---

<div style="text-align:center">
  <img src="images/cognito-identity-pool-diagram.png" alt="Cognito Identity Pool Overview" style="width:80%; border-radius: 15px;">
</div>

---

## ğŸ” **What Are Identity Pools?**

An **Identity Pool** provides **temporary AWS credentials** to users who are:

| Source                                | Description                                             |
| ------------------------------------- | ------------------------------------------------------- |
| ğŸ” Cognito User Pool                  | Authenticated users from your own AWS Cognito user base |
| ğŸŒ OpenID Connect (OIDC)              | Any OIDC-compliant identity provider                    |
| ğŸ“± Social IdPs                        | Facebook, Google, Amazon, Apple                         |
| ğŸ¢ SAML                               | Enterprise IdPs (e.g., Okta, AD FS, Azure AD)           |
| ğŸ§ª Developer Authenticated Identities | Custom login systems generating JWTs                    |
| ğŸ‘¤ Guest Access                       | Unauthenticated, anonymous users                        |

---

## ğŸ§° **Key Features of Identity Pools**

| Feature                            | Description                                                              |
| ---------------------------------- | ------------------------------------------------------------------------ |
| ğŸ¯ **STS Integration**             | Uses **AWS STS** to generate short-lived, scoped credentials             |
| ğŸ§‘â€âš–ï¸ **IAM Role Mapping**         | Assign IAM roles to users (authenticated or guest) based on login method |
| ğŸ” **Authorization (not authN)**   | Does not verify identity â€” thatâ€™s the job of the IdP                     |
| ğŸ”‘ **Fine-grained Access Control** | Use IAM policy variables like `${cognito-identity.amazonaws.com:sub}`    |
| âœ… **Built-in Guest Support**      | Allow users to access public resources without logging in                |

---

## ğŸ§­ **CIP Flow â€“ Architecture Diagram**

```mermaid
sequenceDiagram
  autonumber
  participant App as Web/Mobile App
  participant IdP as External IdP / Cognito User Pool
  participant CIP as Cognito Identity Pool
  participant STS as AWS STS
  participant AWS as S3 / DynamoDB / etc.

  App->>IdP: 1ï¸âƒ£ Login and obtain ID/OAuth token
  App->>CIP: 2ï¸âƒ£ Exchange token for AWS credentials
  CIP->>STS: 3ï¸âƒ£ Request temporary credentials
  STS->>CIP: 4ï¸âƒ£ Return AWS credentials
  CIP->>App: 5ï¸âƒ£ Send credentials
  App->>AWS: 6ï¸âƒ£ Access AWS services directly
```

---

## ğŸ›¡ï¸ **IAM Role Mapping in CIP**

CIP uses IAM roles and **trust policies** to map **user identities to specific permissions**.

### ğŸ” **Default Roles**

- **Authenticated role**: Assigned to users who signed in via any IdP
- **Unauthenticated role**: For guest users

---

### ğŸ§© **Sample Trust Policy for Role**

```json
{
  "Effect": "Allow",
  "Principal": {
    "Federated": "cognito-identity.amazonaws.com"
  },
  "Action": "sts:AssumeRoleWithWebIdentity",
  "Condition": {
    "StringEquals": {
      "cognito-identity.amazonaws.com:aud": "<identity-pool-id>"
    },
    "ForAnyValue:StringLike": {
      "cognito-identity.amazonaws.com:amr": "authenticated"
    }
  }
}
```

---

## ğŸ” **Example 1 â€“ S3 Bucket Scoped Access**

Let each user access their **own folder** in an S3 bucket:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Action": ["s3:ListBucket"],
      "Effect": "Allow",
      "Resource": ["arn:aws:s3:::mybucket"],
      "Condition": {
        "StringLike": {
          "s3:prefix": ["${cognito-identity.amazonaws.com:sub}/*"]
        }
      }
    },
    {
      "Action": ["s3:GetObject", "s3:PutObject"],
      "Effect": "Allow",
      "Resource": ["arn:aws:s3:::mybucket/${cognito-identity.amazonaws.com:sub}/*"]
    }
  ]
}
```

---

## ğŸ“¦ **Example 2 â€“ Scoped DynamoDB Row-Level Access**

Allow users access to **only their own rows** using partition key:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["dynamodb:GetItem", "dynamodb:PutItem", "dynamodb:Query", "dynamodb:UpdateItem"],
      "Resource": "arn:aws:dynamodb:us-east-1:123456789012:table/MyTable",
      "Condition": {
        "ForAllValues:StringEquals": {
          "dynamodb:LeadingKeys": ["${cognito-identity.amazonaws.com:sub}"]
        }
      }
    }
  ]
}
```

---

## ğŸŒ **CIP + CUP: Full Federated Architecture**

When you **combine User Pools and Identity Pools**, you get full **authentication + authorization**:

---

<div style="text-align:center">
  <img src="images/cognito-cip-integration-with-cup.png" alt="CUP + CIP Integration" style="width:80%; border-radius: 15px;">
</div>

---

> CUP = Sign-in experience (OAuth2, Email/Password, Social)  
> CIP = Maps token â†’ STS â†’ IAM roles â†’ AWS resource access

---

## âœğŸ» **Full Example**

<div style="text-align: center;">
    <img src="images/cognito-identity-pool-project-demo.png" alt="cognito-identity-pool-project-demo" style="border-radius: 10px; width: 60%;">
</div>

---

## ğŸ“Œ **CIP Summary Table**

| Cognito Feature        | Identity Pools                     |
| ---------------------- | ---------------------------------- |
| ğŸ” AuthN Source        | External IdPs, CUP, or custom      |
| ğŸ« Token Used          | OIDC / OAuth / SAML tokens         |
| ğŸ§­ Goal                | Temporary AWS credentials (STS)    |
| ğŸ“œ IAM Policy Support  | âœ… Yes (with fine-grained control) |
| ğŸ‘¤ Guest User Support  | âœ… Yes                             |
| ğŸªª Federated Identities | âœ… OIDC, SAML, Facebook, Google    |

---

## ğŸ **Final Thoughts**

- âœ… Use **Identity Pools** when you want **temporary AWS access** for frontend users.
- âœ… Combine with **User Pools** for secure and user-friendly authentication.
- âœ… Always map IAM roles carefully and use **policy variables** for secure, per-user access.
- âœ… Enable **CloudWatch Logs** to track STS credential usage and access.
