# ğŸ›‘ **Restricting S3 Bucket Access to CloudFront Only (Using Origin Access Control - OAC)**

> **OAC** is the **modern way** _(old way was OAI)_ to securely grant CloudFront access to S3 buckets **without making your bucket public**.  
> _Ensure your S3 bucket content is **served only through CloudFront**, not accessible directly over the internet._

---

## ğŸ” **What Is Origin Access Control (OAC)?**

**Origin Access Control (OAC)** is the modern, more flexible replacement for Origin Access Identity (OAI). It lets **CloudFront securely access private S3 buckets** by signing requests and authenticating using IAM-style policies.

âœ… Use OAC when your S3 bucket is **not a static website endpoint** (i.e., use a **REST API-style S3 bucket**).

---

## âš™ï¸ **How OAC Works â€“ Behind the Scenes**

ğŸ”’ **CloudFront signs requests** to the S3 bucket on your behalf.

ğŸ“œ **S3 bucket policy** allows access only if:

- The request is **signed by CloudFront**
- The request **matches the CloudFront distributionâ€™s ARN**

âŒ **No public access needed** â€” `Block Public Access` can stay **fully enabled**.

---

<div align="center">
  <img src="images/s3-cloudfront-oac.png" alt="CloudFront OAC S3" style="border-radius: 10px; width: 40%;">

---

```mermaid
sequenceDiagram
    participant ğŸ‘¤ as ğŸ‘¤ Viewer
    participant ğŸŒ as ğŸŒ CloudFront Edge
    participant ğŸ” as ğŸ” OAC Signing Layer
    participant ğŸª£ as ğŸª£ S3 Bucket (private)

    ğŸ‘¤->>ğŸŒ: Request /assets/logo.png
    Note over ğŸŒ: Cache lookup â†’ Miss
    ğŸŒ->>ğŸ”: Sign Origin Request (SigV4)
    ğŸ”-->>ğŸŒ: Return Signed Request
    ğŸŒ->>ğŸª£: Make Authenticated Request
    ğŸª£-->>ğŸŒ: Return Object
    ğŸŒ-->>ğŸ‘¤: Serve Response
```

</div>

---

## ğŸ”‘ **OAC Signing Behavior Options**

| Mode                        | Behavior                                                                                                 |
| --------------------------- | -------------------------------------------------------------------------------------------------------- |
| âœ… **Sign origin requests** | CloudFront **signs** each request to S3 â€” best for private access                                        |
| ğŸš« **Do not sign requests** | CloudFront sends unsigned requests â€” S3 **must be public** (not recommended)                             |
| ğŸ”„ **Pass authorization**   | CloudFront **forwards the Authorization header** from the client (used in signed URLs/cookies workflows) |

---

## ğŸ“œ **Example S3 Bucket Policy (with OAC)**

Hereâ€™s a sample policy to **allow only CloudFront** (via OAC) to get objects from the bucket:

```json
{
  "Version": "2012-10-17",
  "Statement": {
    "Sid": "AllowCloudFrontReadOnly",
    "Effect": "Allow",
    "Principal": {
      "Service": "cloudfront.amazonaws.com"
    },
    "Action": "s3:GetObject",
    "Resource": "arn:aws:s3:::my-bucket-name/*",
    "Condition": {
      "StringEquals": {
        "AWS:SourceArn": "arn:aws:cloudfront::<account-id>:distribution/<distribution-id>"
      }
    }
  }
}
```

> ğŸ“Œ Replace `my-bucket-name`, `<account-id>`, and `<distribution-id>` accordingly.

---

## ğŸ“¦ Sample Use Case

Letâ€™s say you want to use CloudFront with:

- A **private S3 bucket**
- No public access at all
- Only CloudFront should access the content

### Youâ€™ll Need

1. **Create OAC in CloudFront console**
2. Attach it to your S3 Origin
3. Update the **S3 Bucket Policy** like:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowCloudFrontServiceAccess",
      "Effect": "Allow",
      "Principal": {
        "Service": "cloudfront.amazonaws.com"
      },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::your-bucket-name/*",
      "Condition": {
        "StringEquals": {
          "AWS:SourceArn": "arn:aws:cloudfront::YOUR-AWS-ACCOUNT-ID:distribution/YOUR-DISTRIBUTION-ID"
        }
      }
    }
  ]
}
```

> ğŸ” This ensures that **only CloudFront with your specific OAC** can access the bucket.

---

## ğŸ’¡ **Best Practices for OAC & CloudFront with S3**

| Best Practice                            | Why It Matters                                         |
| ---------------------------------------- | ------------------------------------------------------ |
| ğŸ”’ **Block all public access**           | Ensures objects are **only accessible** via CloudFront |
| âœï¸ **Enable request signing**            | Forces CloudFront to authenticate to S3 securely       |
| ğŸ›¡ **Avoid legacy OAI if possible**       | Use **OAC**, which is more powerful and flexible       |
| ğŸ“ˆ **Monitor with CloudWatch + S3 logs** | Track access patterns and potential misconfigurations  |
| ğŸŒ **Use HTTPS only**                    | Ensure secure communication between CloudFront and S3  |

---

## ğŸ“Œ TL;DR â€” Quick FAQ

| â“ Question                        | âœ… Answer                                    |
| ---------------------------------- | -------------------------------------------- |
| Does OAC use pre-signed URLs?      | âŒ No. It signs requests using SigV4 headers |
| Should S3 bucket be public?        | âŒ No. Must block all public access          |
| Who can access the S3 bucket?      | âœ… Only CloudFront using the OAC identity    |
| Is OAC needed for ALB/API origins? | âœ… Yes, OAC supports signed origin requests  |
| Is OAI still used?                 | âš ï¸ Legacy only, not recommended anymore      |

---

## ğŸ **Bonus: AWS Signature Version 4 - SigV4**

### âœ… What is SigV4?

**SigV4** is AWS's method to **sign HTTP requests** using your credentials, ensuring:

- **Authentication** (you are who you say)
- **Integrity** (no tampering)
- **Authorization** (access is valid & scoped)

---

### ğŸ”„ SigV4 Signing Workflow

```mermaid
sequenceDiagram
    participant ğŸ‘¤ as ğŸ‘¤ Requester (CloudFront, SDK, CLI)
    participant ğŸ” as ğŸ” SigV4 Signer
    participant â˜ï¸ as â˜ï¸  AWS Service (e.g., S3)

    ğŸ‘¤->>ğŸ”: Create Request (method, headers, body, etc.)
    ğŸ”->>ğŸ”: Canonicalize the Request ğŸ§¾
    ğŸ”->>ğŸ”: Generate String to Sign âœï¸
    ğŸ”->>ğŸ”: Derive Signing Key using Secret Access Key ğŸ”‘
    ğŸ”->>ğŸ”: Sign the Request (HMAC-SHA256) ğŸ§ª
    ğŸ”-->>ğŸ‘¤: Attach `Authorization` header âœ…
    ğŸ‘¤->>â˜ï¸: Send Signed Request
    â˜ï¸->>â˜ï¸: Verify Signature + Expiry
    â˜ï¸-->>ğŸ‘¤: Allow or Deny Access ğŸš¦
```

---

### ğŸ§  Key Concepts

| Component         | Role                             |
| ----------------- | -------------------------------- |
| Canonical Request | Normalized form of HTTP request  |
| String to Sign    | SHA256-hashed payload + metadata |
| Signing Key       | Derived from your **secret key** |
| Authorization     | Header with full signature info  |

---

### ğŸ” Why Itâ€™s Secure

- Uses HMAC + SHA256
- Tied to **specific date, region, service**
- Expires after short time
- **Secret key never sent**

---

### ğŸ“Œ Used In

- âœ… CloudFront OAC
- âœ… S3 direct API requests
- âœ… Lambda/API Gateway
- âœ… AWS SDKs & CLI

---

### ğŸ§­ **OAC Signing Behavior Options**

| Option                         | What It Does                                                                   |
| ------------------------------ | ------------------------------------------------------------------------------ |
| âŒ Do not sign requests        | No SigV4 â†’ for public origins only                                             |
| âœ… Sign requests (recommended) | CloudFront adds SigV4 to origin requests                                       |
| ğŸ”’ Do not override auth header | If a request already includes `Authorization`, donâ€™t replace it (advanced use) |
