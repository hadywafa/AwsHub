# ğŸ” **Serving Private Content with CloudFront â€“ Private Distribution Edition**

> Use **CloudFront Private Distributions** to securely serve files (videos, PDFs, images) **only to authorized users**, and **prevent direct access** from the internet.

---

## ğŸ§  **What is a CloudFront Private Distribution?**

A **Private Distribution** means:

- Your **origin (e.g., S3 bucket)** is **private**
- **Direct access to content is blocked**
- Only **CloudFront** can access the content (using **OAC** or **OAI**)
- **Viewers need signed proof** to access content (ğŸ”— Signed URL / ğŸª Signed Cookie)

---

## ğŸ” CloudFront Security Has Two Layers

| Layer                     | Purpose                            | Tool                            |
| ------------------------- | ---------------------------------- | ------------------------------- |
| ğŸŒ CDN â†’ ğŸª£ Origin         | Block direct access to S3          | **OAC (Origin Access Control)** |
| ğŸ‘¤ Viewer â†’ ğŸŒ CloudFront | Control who can access the content | **Signed URL or Signed Cookie** |

> âœ… Use **both** for full private distribution security.

---

## ğŸ” **How Private Distribution Works**

<div align="center">

```mermaid
sequenceDiagram
    participant ğŸ‘¤ as ğŸ‘¤ Viewer (User)
    participant ğŸ§  as ğŸ§  Your App (Signer)
    participant ğŸŒ as ğŸŒ CloudFront (Private Distribution)
    participant ğŸª£ as ğŸª£ S3 Bucket (Private via OAC)

    ğŸ‘¤->>ğŸ§ : Request access to private content (login/download)
    ğŸ§ ->>ğŸ§ : Generate Signed URL or Signed Cookie using Private Key ğŸ”
    ğŸ§ -->>ğŸ‘¤: Return Signed URL or Set Signed Cookies ğŸª

    ğŸ‘¤->>ğŸŒ: Access CloudFront URL (with signature in URL or cookies)

    alt Valid Signature âœ…
        ğŸŒ->>ğŸª£: Request object using OAC (SigV4 signed)
        ğŸª£-->>ğŸŒ: Return content
        ğŸŒ-->>ğŸ‘¤: Serve content ğŸ¯
    else Invalid/Expired Signature âŒ
        ğŸŒ-->>ğŸ‘¤: 403 Forbidden
    end
```

</div>

---

<div style="text-align: center;">
    <img src="images/serving-private-content-via-CloudFront.png" alt="Serving Private Content via CloudFront" style="border-radius: 10px;">
</div>

---

## âœï¸ **Signed URL vs. Signed Cookie**

| Feature                | ğŸ”— **Signed URL**                                       | ğŸª **Signed Cookie**                       |
| ---------------------- | ------------------------------------------------------- | ------------------------------------------ |
| Access scope           | One specific file                                       | Multiple files (entire path/domain)        |
| Ideal for              | Direct downloads, single asset sharing                  | Web apps, video streaming, batch resources |
| Works without cookies? | âœ… Yes                                                  | âŒ No â€“ requires cookie support in browser |
| URL visible to user?   | âœ… Yes â€“ visible in browser                             | âŒ No â€“ cookies are stored in browser      |
| Easy to share links?   | âŒ Anyone with link can use it (unless IP/time-limited) | âœ… Harder to leak (tied to session)        |
| Common use cases       | Email file links, one-time downloads                    | Streaming sites, logged-in web apps        |
| Complexity             | Simple to implement                                     | Slightly more setup (set-cookie logic)     |

---

## ğŸ§° **When to Use Which?**

| Scenario                                    | Use              |
| ------------------------------------------- | ---------------- |
| One-time PDF or image link                  | ğŸ”— Signed URL    |
| Authenticated user accessing multiple files | ğŸª Signed Cookie |
| Mobile/desktop apps (no cookies)            | ğŸ”— Signed URL    |
| Video player or AJAX-based app              | ğŸª Signed Cookie |

---

## ğŸ” **Requirements for Private Distribution**

### âœ… 1. S3 Bucket Must Be Private

- Enable **Block Public Access**
- Use **OAC** to let only CloudFront fetch content securely

### âœ… 2. CloudFront Behavior Config

- Edit cache behavior â†’ Enable: **Restrict viewer access**
- Choose: **Use Signed URLs or Cookies**
- Attach: **Key Group** with your public key

### âœ… 3. Use Key Pair to Sign

- Generate RSA key pair locally
- Upload public key to CloudFront
- Use private key in your app to sign URLs or cookies

---

## ğŸ§ª Signed URL Example

```bash
# Expires in 1 hour
https://d123.cloudfront.net/report.pdf
?Expires=1715797200
&Signature=AbCDef123...
&Key-Pair-Id=KABCDEFGHIJK
```

## ğŸª Signed Cookie Example

```http
Set-Cookie: CloudFront-Policy=...
Set-Cookie: CloudFront-Signature=...
Set-Cookie: CloudFront-Key-Pair-Id=...
```

> Userâ€™s browser includes these cookies in every request â€” **no need to change URLs.**

---

## ğŸ› ï¸ **How to Set It Up in AWS (New Console UI)**

Hereâ€™s a step-by-step to generate signed URLs or cookies.

---

### âœ… **Step 1: Create a CloudFront Key Pair**

> This key pair is used to **digitally sign** URLs or cookies.

1. Go to **AWS Management Console** â†’ search for **CloudFront**.
2. On the left, go to **Key management** â†’ **Public keys**.
3. Click **Create public key**.
   - Name: `MyCloudFrontKey`
   - Upload your **public key file** (Youâ€™ll generate this in next steps).
4. Go to **Key Groups** â†’ **Create Key Group**.
   - Name: `MyKeyGroup`
   - Select the public key from the list.
   - Save.

---

### ğŸ§¾ **Step 2: Generate a Key Pair (Locally)**

Use OpenSSL to create the key pair.

```bash
openssl genrsa -out private_key.pem 2048
openssl rsa -pubout -in private_key.pem -out public_key.pem
```

- Upload `public_key.pem` in **Step 1**.
- Use `private_key.pem` in your app to generate signatures.

---

### ğŸ” **Step 3: Restrict Your Content in CloudFront**

> Prevent public access.

1. Go to **CloudFront** â†’ Select your distribution.
2. Choose the **Behavior** tab â†’ Edit your behavior.
3. Under **Restrict Viewer Access (Use Signed URLs or Signed Cookies)**, set it to **Yes**.
4. Choose the **Key Group** you created.
5. Save changes.

---

### âœï¸ **Step 4: Generate Signed URL (Example with Python)**

```python
from aws_cloudfront_signer import CloudFrontSigner
import rsa
from datetime import datetime, timedelta

def rsa_signer(message):
    with open('private_key.pem', 'rb') as key_file:
        private_key = rsa.PrivateKey.load_pkcs1(key_file.read())
    return rsa.sign(message, private_key, 'SHA-1')

key_id = 'YOUR_KEY_ID_FROM_CONSOLE'
signer = CloudFrontSigner(key_id, rsa_signer)

url = signer.generate_presigned_url(
    'https://your-distribution.cloudfront.net/private/video.mp4',
    date_less_than=datetime.utcnow() + timedelta(hours=1)
)

print(url)
```

---

## ğŸ’¡ **Best Practices**

- âŒ Never use root user to create keys.
- âœ… Use short expiry time (e.g., 1 hour).
- ğŸ”’ Store your **private key securely** (use AWS Secrets Manager).
- ğŸ“± Use signed **cookies** for apps that load multiple files in one session.

---

## âœ… Summary

| Task                           | Tool                            |
| ------------------------------ | ------------------------------- |
| Restrict S3 access             | OAC (SigV4 signing)             |
| Secure viewer-level access     | Signed URL or Cookie            |
| One file, no session           | ğŸ”— Signed URL                   |
| Many files/session-wide access | ğŸª Signed Cookie                |
| Full private content delivery  | Combine OAC + Signed URL/Cookie |

---

## ğŸ“š References

- [ğŸ”— Signed URL Doc](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-signed-urls.html)
- [ğŸª Signed Cookie Doc](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/private-content-signed-cookies.html)
