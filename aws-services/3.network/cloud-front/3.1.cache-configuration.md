# ğŸŒ **Amazon CloudFront Cache Configuration â€“ Step-by-Step Workflow**

> ğŸ“¦ Amazon CloudFront is a **Content Delivery Network (CDN)** that caches content at edge locations to deliver it faster to users. But **how** CloudFront decides what to cache, when to cache, and what to send to the origin depends on four key components:

---

<div style="text-align: center;">
  <img src="images/origin-request-policy.png" alt="Origin Request Policy" style="border-radius: 10px;">
</div>

---

## ğŸ§­ **Full Workflow Overview**

<div align="center">

```mermaid
sequenceDiagram
    participant ğŸ‘¤ as ğŸ‘¤ Viewer
    participant ğŸŒ as ğŸŒ CloudFront Edge
    participant ğŸ—„ï¸ as ğŸ—„ï¸ Origin Server

    ğŸ‘¤->>ğŸŒ: Request /product?id=100&lang=en
    Note over ğŸŒ: Match Cache Behavior ğŸ“¦
    ğŸŒ->>ğŸŒ: Generate Cache Key ğŸ§ <br>Include query strings / headers / cookies if defined
    alt Cache Hit
        ğŸŒ->>ğŸŒ: Serve from Cache ğŸ¯
        ğŸŒ-->>ğŸ‘¤: Cached Response âš¡
    else Cache Miss
        ğŸŒ->>ğŸŒ: Object Not in Cache âŒ
        Note over ğŸŒ: Apply Cache Policy ğŸ“œ<br>Set TTL, vary by cookies or headers
        Note over ğŸŒ: Apply Origin Request Policy ğŸ“¨<br>Forward only selected info
        ğŸŒ->>ğŸ—„ï¸: Fetch Object from Origin ğŸŒ
        ğŸ—„ï¸-->>ğŸŒ: Response with Object ğŸ“¦
        ğŸŒ->>ğŸŒ: Cache Object using Key ğŸ§ 
        ğŸŒ-->>ğŸ‘¤: Serve Fresh Response ğŸš€
    end
```

</div>

---

## ğŸ”¹ **Step 1: `Cache Behavior` â€“ What to Match?**

> **Cache Behavior** decides **which request pattern** gets which behavior.

---

<div style="text-align: center;">
  <img src="images/cdn-default-cache-behavior-options.png" style="border-radius: 10px; width: 80%;" alt="Default Cache Behavior Options">
</div>

---

### ğŸ¯ **Purpose:**

- Match request **paths** to specific behaviors
- Define what to **do with that request**

### ğŸ”§ **Config Includes:**

| Option                     | Description                            |
| -------------------------- | -------------------------------------- |
| **Path Pattern**           | e.g., `/images/*` or `/videos/*`       |
| **Origin**                 | Which backend to fetch content from    |
| **Allowed Methods**        | e.g., GET, POST                        |
| **Viewer Protocol Policy** | Redirect HTTP to HTTPS?                |
| **Associated Policies**    | Attach Cache & Origin Request Policies |

---

## ğŸ§© **Step 2: `Cache Key` â€“ What to Use to Identify a Cached Object?**

> A **Cache Key** is a **unique fingerprint** that CloudFront uses to check if the content is already cached.

### ğŸ§  **Think of It As:**

> ğŸ¤” â€œHow can I know if Iâ€™ve seen this request before?â€
> ğŸ’¡ If two requests have the same cache key â†’ CloudFront can reuse the cached content.

### ğŸ”§ **By Default, the Cache Key Includes:**

1. **Host header** â†’ e.g., `d123.cloudfront.net`
2. **Request path** â†’ e.g., `/images/logo.png`

---

### ğŸ›ï¸ **Optionally, You Can Add to the Cache Key:**

| Type              | Example                         | Why?                                      |
| ----------------- | ------------------------------- | ----------------------------------------- |
| **Query strings** | `?lang=en&size=large`           | Cache different versions of the same path |
| **Headers**       | `Accept-Encoding`, `User-Agent` | Cache per device, encoding, etc.          |
| **Cookies**       | `session-id`, `user-preference` | Personalize cache by user/session         |

These are **not included by default** â€” you configure this via a **Cache Policy**.

---

### ğŸ“¦ Cache Key Construction Example

Say you configure your **Cache Policy** to include:

- Query string: `lang`
- Header: `Accept-Encoding`
- Cookie: `user-id`

Then for this request:

```http
GET /product?id=10&lang=en HTTP/1.1
Host: d123.cloudfront.net
Cookie: user-id=789; session=abc
Accept-Encoding: gzip
```

âœ… The Cache Key will be based on:

```ini
d123.cloudfront.net/product
+ lang=en
+ Accept-Encoding=gzip
+ Cookie user-id=789
```

> ğŸ” So if another user comes with a different `lang` or `user-id`, they'll **generate a different cache key** â†’ and may get a cache **miss**.

---

## ğŸ§® **Step 3: `Cache Policy` â€“ How to Cache It?**

> **Cache Policy** controls **how long to cache** and **what to include** in the cache key.

---

<div style="text-align: center;">
  <img src="images/cdn-cache-key-and-origin-requests-options.png" style="border-radius: 10px; width: 80%;" alt="Cache Key and Origin Requests Options">
</div>

---

### ğŸ§° **Whatâ€™s Inside:**

| Feature                | Purpose                                  |
| ---------------------- | ---------------------------------------- |
| **TTL (Time To Live)** | How long to keep object cached           |
| **Query Strings**      | Add query values to cache key?           |
| **Headers**            | e.g., `Accept-Encoding` for gzip support |
| **Cookies**            | Different cache per user session?        |

> ğŸ”„ If the cache key doesnâ€™t match or TTL expires â†’ itâ€™s a **cache miss** and CloudFront goes to the origin.

---

## ğŸšš **Step 4: `Origin Request Policy` â€“ What to Send to Origin?**

> This controls what info CloudFront forwards **to your backend** (e.g., S3, ALB, EC2, etc.)

### ğŸ” **Main Job:**

> Prevent unnecessary data (cookies, headers) from going to the origin.

### ğŸ› **What You Can Control:**

| Data              | Example                                     |
| ----------------- | ------------------------------------------- |
| **Query Strings** | Only forward needed ones like `?version=2`  |
| **Headers**       | Forward `Authorization`, block others       |
| **Cookies**       | Send `session-id`, ignore marketing cookies |

> âœ… Less forwarded data = lower origin load = faster responses.

---

## ğŸ **Final Step: Object Caching & Response**

1. CloudFront receives the response from the origin.
2. It stores the object at the edge cache **using the Cache Key**.
3. Serves the response to the viewer.
4. For future requests, **checks the cache first** using the same key.

---

## ğŸ§  **Summary Table: 4 Key Components**

| Component                 | Think of It As... | Controls                       |
| ------------------------- | ----------------- | ------------------------------ |
| **Cache Behavior**        | Rulebook          | What URLs get what behavior    |
| **Cache Key**             | Object ID         | Helps determine cache hit/miss |
| **Cache Policy**          | Memory Settings   | What to cache + for how long   |
| **Origin Request Policy** | What to Send      | Controls what goes to origin   |

---

## ğŸ’¡ Real Example

You want:

- `/images/*` to be cached based on query param like `?size=large`
- Only send `Accept-Language` header to origin
- Cache for 1 hour

Youâ€™d configure:

| Setting                   | Value                                    |
| ------------------------- | ---------------------------------------- |
| **Cache Behavior**        | Path = `/images/*`, origin = S3          |
| **Cache Policy**          | Include query string `size`, TTL = 3600s |
| **Origin Request Policy** | Forward `Accept-Language` header only    |

---

## ğŸ§  Tips for Mastery

- Use **Managed Policies** first (like `CachingOptimized`) to avoid over-customizing
- Analyze **cache hit ratio** in CloudFront metrics
- Donâ€™t forward unnecessary headers or cookies unless required by backend
