# ğŸ§  **Deep Dive: How Route 53 Health Checks Work Internally**

> **Not just pinging.** Itâ€™s a globally distributed system for real-time DNS routing based on health!

---

## ğŸ’¡ **Whatâ€™s a Health Check in Route 53 (at a glance)?**

Health Checks in Route 53 continuously **probe endpoints** like:

- Web servers
- Load balancers
- APIs

If an endpoint becomes **unhealthy**, Route 53 automatically **stops routing traffic** to it and redirects traffic to a healthy one â€” depending on your routing policy (**failover**, **latency-based**, or **weighted**).

But whatâ€™s happening **under the hood**? Letâ€™s visualize it ğŸ”

---

## ğŸ”„ **Behind the Scenes: Health Checks Workflow + DNS Routing**

<div align="center">

```mermaid
sequenceDiagram
    ğŸ–¥ï¸ Route53 Console/API->>ğŸ“¡ HealthCheckerFleet: Configure health check (HTTP/TCP, interval, path)

    loop Every 30s (default)
        ğŸ“¡ HealthCheckerFleet->>ğŸ¯ TargetResources: Send health probe (GET /health or TCP SYN)
        ğŸ¯ TargetResources-->>ğŸ“¡ HealthCheckerFleet: Return HTTP or TCP response (200 OK / Failure)
        ğŸ“¡ HealthCheckerFleet->>ğŸ“Š HealthStatusTracker: Log pass/fail
    end

    ğŸ“Š HealthStatusTracker-->>ğŸ–¥ï¸ Route53 Console/API: Update health status
    ğŸ–¥ï¸ Route53 Console/API-->>ğŸŒ DNS Resolver: Adjust DNS response to serve only healthy targets
    ğŸŒ DNS Resolver->>ğŸŒ ISP Cache: Store response using TTL
```

</div>

---

## ğŸ•’ **How TTL Affects the Flow (Caching Behavior)**

<div align="center">

```mermaid
sequenceDiagram
    participant ğŸ§‘â€ğŸ’» User Browser
    participant ğŸŒ DNS Resolver
    participant ğŸ–¥ï¸ Route 53
    participant ğŸŒ ISP Cache

    ğŸ§‘â€ğŸ’» User Browser->>ğŸŒ DNS Resolver: Request example.com?

    alt Cached IPs Exist
        ğŸŒ DNS Resolver-->>ğŸ§‘â€ğŸ’» User Browser: Return cached IPs (TTL valid) âœ…
    else TTL Expired / No Cache
        ğŸŒ DNS Resolver->>ğŸ–¥ï¸ Route 53: Query fresh resolution
        ğŸ–¥ï¸ Route 53-->>ğŸŒ DNS Resolver: Return only healthy IPs
        ğŸŒ DNS Resolver->>ğŸŒ ISP Cache: Save records with TTL
        ğŸŒ DNS Resolver-->>ğŸ§‘â€ğŸ’» User Browser: Serve fresh IPs ğŸ”„
    end
```

</div>

---

## ğŸ§ª **Example Response (Healthy Targets Only)**

```txt
DNS Query: example.com
Route 53 Response:
54.193.127.2 (TTL: 300s)
18.144.23.89 (TTL: 300s)
192.0.2.156 (TTL: 300s)
```

âœ”ï¸ Only **healthy** IPs returned  
ğŸ“¦ TTL used to **cache at ISP level**

---

## ğŸŒ **1. Health Checker Fleet â€“ Global & Independent**

AWS runs a **global fleet** of health checker agents â€” small EC2s or containers â€” from \~15+ AWS regions:

ğŸ”¹ Each one checks **independently**  
ğŸ”¹ No result sharing or central cache  
ğŸ”¹ All probes are made **publicly over the internet**

By default:

> ğŸ”„ **3â€“5 agents probe your endpoint every 30 seconds**

---

## âš™ï¸ **2. What Health Checkers Actually Do**

Depending on your config:

| Protocol       | What It Does                                                                     |
| -------------- | -------------------------------------------------------------------------------- |
| **HTTP**       | Sends GET to a path (e.g. `/health`) â†’ expects 2xx or 3xx response               |
| **HTTPS**      | Same as HTTP + TLS handshake                                                     |
| **TCP**        | Attempts a socket connection to the port                                         |
| **Calculated** | Logical combo of other checks (e.g. AND/OR conditions across multiple resources) |

ğŸ§  **Each probe:**

- Doesnâ€™t use cache
- Times out in 4 seconds (default)
- Retries on failure before declaring unhealthy

---

## ğŸ—³ï¸ **3. Consensus Logic â€“ Majority Vote System**

AWS uses **quorum logic** to determine health:

âœ… **If â‰¥80% probes are successful** â†’ Healthy  
âŒ **If >20% fail** â†’ Unhealthy

> Prevents false alarms due to regional outages or random failures.

---

## ğŸ” **4. Real-Time Sync With DNS Responses**

When a target is unhealthy:

- Route 53 **removes it** from DNS answers
- If failover is enabled â†’ it switches to a secondary target
- With weighted/latency â†’ unhealthy IP is **skipped**

> This happens **immediately**, even before TTL expires, if:
>
> `EvaluateTargetHealth = true`

---

## ğŸ§¬ **5. Alias Records: Smarter Health Evaluation**

When using **Alias Records** (e.g., pointing to ALB, NLB, CloudFront):

âœ”ï¸ You **donâ€™t need** a custom health check  
âœ”ï¸ Route 53 checks health **internally**

> âš ï¸ Requires you to set **Evaluate Target Health = true**

---

## ğŸ§ª **Full Example: HTTPS Health Check Flow**

Imagine:

```ini
Protocol = HTTPS
Target IP = 3.122.150.10
Path = /health
Port = 443
Interval = 30s
```

Every 30 seconds:

```bash
GET https://3.122.150.10/health
```

Checks:

- TLS handshake OK?
- Status 200/302?
- Response within timeout?

â†’ 4/5 agents say OK â†’ âœ…  
â†’ â‰¥3 fail â†’ âŒ DNS stops routing to it

---

## ğŸ” **Security Checklist**

| Do / Donâ€™t              | Notes                                                                                                                                                                             |
| ----------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| âœ… Public access        | Health checkers must reach your target over the internet                                                                                                                          |
| âœ… IP allowlists        | Use AWS published health check [IP ranges](https://ip-ranges.amazonaws.com/ip-ranges.json) - [Docs](https://docs.aws.amazon.com/general/latest/gr/route53.html#route53-ip-ranges) |
| âŒ Internal-only checks | Instead use **Alias + Evaluate Target Health**                                                                                                                                    |

---

## âš ï¸ **Common Pitfalls & Fixes**

| âŒ Pitfall                            | âœ… Solution                                                |
| ------------------------------------- | ---------------------------------------------------------- |
| Blocking health checker IPs           | Allow Route 53 IPs in security groups/NACLs                |
| TTL too long                          | TTL doesn't block failover, but can delay fresh resolution |
| Monitoring private/internal endpoints | Use AWS-native targets with alias records                  |

---

## âœ… **Wrap-Up: End-to-End Recap**

| ğŸ” Layer            | ğŸ”§ What Happens                                                 |
| ------------------- | --------------------------------------------------------------- |
| ğŸ“„ Config           | You define protocol, path, port, interval, threshold            |
| ğŸŒ Global Probes    | Route 53 health checkers ping your target from multiple regions |
| ğŸ§  Quorum           | AWS stores results and uses majority to decide health           |
| ğŸ“‰ DNS Impact       | Unhealthy targets are removed from DNS answers                  |
| ğŸ” Auto Failover    | DNS routes traffic to backup if primary fails                   |
| ğŸ§  Alias Efficiency | Skip custom checks by using AWS-native health for alias targets |
