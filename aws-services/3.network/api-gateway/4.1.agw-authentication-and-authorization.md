# üîê **Amazon API Gateway ‚Äì Security Deep Dive**

> API Gateway is the front door to your backend ‚Äî so **securing it is critical**.
> It supports **multiple security layers** depending on your use case, including **IAM**, **Cognito**, **Lambda Authorizers**, and **Resource Policies**.

---

## üß≠ **API Gateway Security ‚Äì Two Categories**

### üõ°Ô∏è **IAM-Based (SigV4)**

Used when **clients are AWS entities** (like EC2, Lambda, CLI, SDK) that can sign requests using IAM credentials.

| Mechanism                | Description                                                                        |
| ------------------------ | ---------------------------------------------------------------------------------- |
| ‚úÖ **IAM Authorization** | Uses **SigV4** signed requests + IAM policy to allow/deny access                   |
| ‚úÖ **Resource Policies** | Attach **resource-level rules** (like IP/VPC restrictions or cross-account access) |
| üîÅ **Combined**          | You can **combine IAM with Resource Policies** for enhanced control                |

üìå **Great for:**

- Internal AWS-to-AWS access
- Cross-account secure access
- IP-restricted public APIs

---

### üîê **Authorizers (User-Driven Authentication)**

Used when **external users** or **tokens** are involved. Gateway verifies tokens and grants access.

| Mechanism                          | Description                                                                  |
| ---------------------------------- | ---------------------------------------------------------------------------- |
| ‚úÖ **Cognito User Pools**          | Managed user pool with login, token issuance, auto-validation in API Gateway |
| ‚úÖ **Lambda Authorizer ‚Äì Token**   | You validate custom token (e.g. JWT, OAuth2) in a Lambda function            |
| ‚úÖ **Lambda Authorizer ‚Äì Request** | Fully customizable, trigger Lambda based on headers, query, or stage params  |

üìå **Great for:**

- Web/mobile applications
- Social login (Google, Facebook)
- Third-party identity systems
- Advanced custom authorization logic

---

## üîí **1. IAM-Based Authorization (SigV4)**

> ‚úÖ Best for **internal AWS clients** (EC2, Lambda, CLI, SDKs)

---

<div style="text-align: center;">
  <img src="images/agw-auth-iam.png" alt="API Gateway IAM Authorization" style="border-radius: 10px; width: 60%;" />
</div>

---

### üîß How It Works

- Clients **sign requests using AWS Signature Version 4**
- Gateway verifies signature + IAM policy permissions

### üß† Authentication & Authorization

| Step           | Responsibility                            |
| -------------- | ----------------------------------------- |
| Authentication | IAM credentials (Access Key & Secret Key) |
| Authorization  | IAM policies (attached to user or role)   |

### üìå Good For

- EC2, Lambda, or users **inside the same AWS account**
- **Cross-account access** using **resource policies**

---

### ‚úÖ Example IAM Policy (API Invoke)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": "execute-api:Invoke",
      "Resource": "arn:aws:execute-api:us-east-1:123456789012:api-id/*/GET/resource"
    }
  ]
}
```

---

## üõ°Ô∏è **2. API Gateway Resource Policies**

> Like **bucket policies** or **Lambda resource policies**, but for APIs.

---

<div style="text-align: center;">
    <img src="images/agw-auth-resource-policies.png" alt="agw-auth-resource-policies" style="border-radius: 10px; width: 60%;">
</div>

---

### ‚úÖ What You Can Do

- Allow access from:

  - Specific **AWS accounts**
  - Specific **IP addresses**
  - Specific **VPC endpoints**

- Deny access explicitly (IP block, CIDR range, etc.)

### üß† Use With

- IAM or Lambda Authorizer for **fine-grained security**
- Public APIs where you need to restrict based on **network location**

### ‚úÖ Example: Restrict to VPC Endpoint

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": "*",
      "Action": "execute-api:Invoke",
      "Resource": "arn:aws:execute-api:us-east-1:123456789012:api-id/*",
      "Condition": {
        "StringEquals": {
          "aws:SourceVpce": "vpce-abc123"
        }
      }
    }
  ]
}
```

---

## üßë‚Äçü§ù‚Äçüßë **4. Cognito User Pools**

> Best for **user-based authentication** (apps, websites, mobile users).

---

<div style="text-align: center;">
    <img src="images/agw-auth-cognito.png" alt="agw-auth-cognito" style="border-radius: 10px; width: 60%;">
</div>

---

### ‚úÖ Features

- Managed **user pool** (signup, login, password reset, MFA)
- Supports **federated identity** (Google, Facebook, Apple)
- API Gateway handles **token verification** automatically

### üß† Auth Flow

```mermaid
sequenceDiagram
    participant User
    participant Cognito
    participant API Gateway
    participant Lambda

    User->>Cognito: Sign in ‚Üí JWT Token
    User->>API Gateway: Call API with JWT
    API Gateway->>Cognito: Validate token
    API Gateway->>Lambda: Forward request if valid
```

### üìå Best For

- **External users** (mobile/web apps)
- Simple auth flows with no custom logic

> üîê Auth = Cognito
> ‚öñÔ∏è Authorization = Backend or method-level access control

---

## üß† **5. Lambda Authorizers (Custom Authorizers)**

> ‚úÖ Best for **3rd-party tokens** like **OAuth2**, **JWT**, or **custom headers**

---

<div style="text-align: center;">
    <img src="images/agw-auth-lambda-authorizers.png" alt="Lambda Authorizers" style="border-radius: 10px; width: 60%;">
</div>

---

### üì¶ How It Works

- API Gateway invokes a Lambda **before forwarding request**
- Lambda **verifies token or custom logic**
- Returns an **IAM policy** with `Allow` or `Deny`

---

### Types of Lambda Authorizers

| Type        | Triggered By             | Use Case                         |
| ----------- | ------------------------ | -------------------------------- |
| **Token**   | `Authorization` header   | JWT, OAuth, custom bearer token  |
| **Request** | Any param, header, query | Flexible ‚Äì custom logic by input |

### ‚úÖ Example: Token-Based

1. Client sends:

   ```ini
   Authorization: Bearer eyJhbGci...
   ```

2. API Gateway calls your Lambda Authorizer
3. Lambda verifies the token, returns IAM policy:

   ```json
   {
     "principalId": "user123",
     "policyDocument": {
       "Statement": [
         {
           "Effect": "Allow",
           "Action": "execute-api:Invoke",
           "Resource": "arn:aws:execute-api:region:account-id:api-id/*/GET/resource"
         }
       ]
     }
   }
   ```

### üìå Notes

- Lambda result is **cached** (default: 300 seconds)
- You pay per **Lambda Authorizer invocation**

---

## üß† Summary Table ‚Äì API Gateway Security Options

| Option                | Best For                       | Auth          | Authorization             | Mapping           | Custom Code? |
| --------------------- | ------------------------------ | ------------- | ------------------------- | ----------------- | ------------ |
| **IAM**               | AWS users, EC2, CLI, SDK       | IAM SigV4     | IAM policy                | ‚ùå No             | ‚ùå No        |
| **Resource Policy**   | Cross-account, IP, VPC         | None          | Resource policy           | ‚ùå No             | ‚ùå No        |
| **Cognito**           | App/mobile users               | JWT (Cognito) | API Gateway or backend    | ‚ùå No             | ‚ùå No        |
| **Lambda Authorizer** | 3rd-party tokens, custom logic | External      | Lambda returns IAM policy | ‚úÖ Yes (optional) | ‚úÖ Yes       |

---

## ‚úÖ Best Practices

| Use Case                               | Best Option                      |
| -------------------------------------- | -------------------------------- |
| AWS service ‚Üí API Gateway              | IAM + Resource Policy            |
| Web/Mobile users with login            | Cognito User Pools               |
| Using Auth0 / Firebase / Google tokens | Lambda Authorizer (Token mode)   |
| Limit access to IP or VPC only         | Resource Policy                  |
| Need custom business logic             | Lambda Authorizer (Request mode) |
