# âš¡ **Amazon API Gateway â€“ Caching**

> **API Gateway Caching** allows you to **store API responses temporarily** at the **stage level**, so repeated requests can be **served from the cache** instead of hitting your backend every time.  
> This boosts performance, reduces cost, and improves scalability â€” especially in production.

---

<div style="text-align: center;">
    <img src="images/agw-caching.png" alt="agw-caching" style="border-radius: 10px; width: 70%;">
</div>

---

## ğŸš€ **What Does API Gateway Cache Do?**

âœ… It stores **responses** for a given request (e.g., a `GET /products/123`)
âœ… On repeated calls with the same parameters, it returns the **cached response**
âœ… No Lambda invocation or backend processing is needed

---

## ğŸ“¦ **Key Cache Features**

| Setting                    | Description                                                    |
| -------------------------- | -------------------------------------------------------------- |
| âœ… **Per Stage**           | Cache is defined at the **stage level** (e.g., `/prod`)        |
| âš™ï¸ **Per Method Override** | You can override TTL/cache per method (e.g., `/products/{id}`) |
| ğŸ•’ **TTL (Time to Live)**  | Default: **300 seconds** (range: 0s to 3600s)                  |
| ğŸ” **Encryption**          | Optional â€” encrypts cached data at rest                        |
| ğŸ’¾ **Capacity Range**      | Between **0.5 GB to 237 GB** (scalable)                        |
| ğŸ’¸ **Cost**                | Itâ€™s paid and **should be used mostly in production**          |

---

## ğŸ” **How Caching Works â€“ Behind the Scenes**

<div align="center">

```mermaid
sequenceDiagram
    participant Client
    participant API Gateway
    participant Lambda

    Client->>API Gateway: GET /products/123
    API Gateway-->>Lambda: Only on first request
    Lambda-->>API Gateway: JSON response
    API Gateway-->>Client: Serve & store in cache

    Client->>API Gateway: GET /products/123 again
    API Gateway-->>Client: ğŸ” Return cached response
```

</div>

> ğŸ‘‰ The cache key is based on **method + query/path params + headers**  
> ğŸ‘‰ If anything differs â†’ itâ€™s a **cache miss**

---

## ğŸ® **How to Enable Caching (Console)**

1. Go to **API Gateway â†’ Stages â†’ \[Your Stage]**
2. Scroll to **Cache Settings**
3. Enable **Caching**
4. Set **TTL**, size, encryption if needed
5. (Optional) Go to **Method Request** and override per-method settings

---

## ğŸ§ª Example Use Case â€“ Caching a Product Endpoint

- Endpoint: `GET /products/{id}`
- Cache TTL: `300` seconds
- If `/products/123` is called multiple times â†’ only the first hits the backend
- All others (within 5 minutes) are **served instantly**

---

## ğŸ§¼ **Cache Invalidation (How to Clear Cache)**

Sometimes you need to refresh the cache when:

- Data has changed
- You deployed a new version
- You want immediate consistency

### âœ… 3 Ways to Invalidate Cache

| Method                             | Description                                   |
| ---------------------------------- | --------------------------------------------- |
| ğŸ” **Manual flush** (console/CLI)  | Clear all cached responses instantly          |
| ğŸ§  **Header-based invalidation**   | Clients send: `Cache-Control: max-age=0`      |
| ğŸ” **IAM-controlled invalidation** | You can **restrict who can invalidate cache** |

---

### ğŸ” Example: Secure Header-Based Invalidation

To **allow clients to clear cache with a header**, you must:

- Add `Cache-Control` header
- Check the box **"Require authorization for cache invalidation"**
- Ensure the client has this IAM permission:

  ```json
  "apigateway:InvalidateCache"
  ```

ğŸ“Œ If you **donâ€™t enforce it**, **any client can flush the cache**, which could be abused.

---

## âœ… Best Practices

| Practice                            | Why?                                    |
| ----------------------------------- | --------------------------------------- |
| Use in **production only**          | It costs more and adds complexity       |
| Use on **GET/HEAD methods only**    | Caching `POST`/`PUT` doesn't make sense |
| Cache only **read-heavy** endpoints | Maximize performance gains              |
| Monitor **cache hit rate**          | Find out if caching is helping          |
| Enable **encryption** if needed     | For sensitive cached data               |
