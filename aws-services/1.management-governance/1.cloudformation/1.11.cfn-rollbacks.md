# ğŸ” **CloudFormation Rollback**

> In AWS CloudFormation, **rollback** is the automatic mechanism that ensures your infrastructure doesn't stay in a **partially failed or inconsistent state** during stack **creation** or **update**.

---

## ğŸ¯ Why Rollbacks Matter (Exam Framing)

- âœ… Ensures **stack integrity** during failures
- âœ… Helps recover from **template errors, invalid parameters, or resource limits**
- âœ… Critical in **automated deployments** where unattended updates occur
- âœ… Needed in **CI/CD**, **nested stacks**, and **blue/green deployments**

---

## ğŸ§± Types of Rollbacks

| Scenario                    | What Happens                                                       |
| --------------------------- | ------------------------------------------------------------------ |
| âŒ **Stack Creation Fails** | Entire stack **rolls back (deletes all resources)** by default     |
| âŒ **Stack Update Fails**   | CloudFormation **reverts** to last known stable state              |
| ğŸ”„ **Nested Stack Fails**   | Parent stack **fails**, rollback cascades unless handled           |
| ğŸ§¯ **Rollback Fails**       | Stack enters `UPDATE_ROLLBACK_FAILED` â†’ manual intervention needed |

---

## ğŸ› ï¸ **Controlling Rollbacks**

### 1ï¸âƒ£ **Disable Rollback** (during stack creation)

| Use When                        | How to Enable                              |
| ------------------------------- | ------------------------------------------ |
| Debugging failed stack creation | In Console â†’ uncheck "Rollback on failure" |
|                                 | CLI: `--disable-rollback`                  |

> ğŸ” Leaves failed resources intact so you can **inspect logs, configs, resource state**

---

### 2ï¸âƒ£ **Continue Rollback** (after partial update rollback failure)

> When rollback fails (e.g., a resource **canâ€™t be deleted** or is in a bad state), stack goes to:

```plaintext
UPDATE_ROLLBACK_FAILED
```

To recover:

- ğŸ”§ **Fix manually** (e.g., delete a blocked resource)
- Then call:

```bash
aws cloudformation continue-update-rollback --stack-name your-stack
```

Or from **Console** â†’ **Actions â†’ Continue rollback**

---

## ğŸ§ª Real-World Examples Where Rollback Triggers

| Trigger                        | Explanation                             |
| ------------------------------ | --------------------------------------- |
| ğŸš« IAM permission denied       | CFN canâ€™t create/modify a resource      |
| ğŸš« Insufficient EC2/VPC quota  | Exceeds service limits                  |
| ğŸš« Lambda timeout or error     | Resource remains in CREATE_FAILED       |
| ğŸš« S3 Bucket Name conflict     | Global uniqueness violation             |
| ğŸš« Resource dependency failure | Nested stack or `DependsOn` chain fails |

---

## ğŸ“Œ Rollback Behavior in Nested Stacks

- Failure in nested stack causes **parent rollback** unless `OnFailure: DELETE/RETAIN/DO_NOTHING` is specified
- **Stack policies** can be used to **protect critical resources from deletion**, which may result in rollback failure!

---

## ğŸ§  Key CLI Commands for Rollback (SAP-Focused)

| Command                          | Purpose                            |
| -------------------------------- | ---------------------------------- |
| `--disable-rollback`             | Prevent deletion on failure        |
| `continue-update-rollback`       | Resume after rollback failure      |
| `describe-stack-events`          | View rollback failure logs         |
| `delete-stack`                   | Force delete failed stack          |
| `describe-stack-resource-drifts` | Detect config drifts post-rollback |

---

## ğŸ” Integration with Stack Policies (Rollback Impact)

- Resources **protected by stack policies** may **block updates or deletion**
- If you try to update a protected resource â†’ CFN **fails the update** and **rolls back**
- To fix: temporarily **remove stack policy**, update the resource, then re-apply policy

---

## âœ… Best Practices for SAP Exam and Real Life

| Best Practice                            | Why It Matters                     |
| ---------------------------------------- | ---------------------------------- |
| Always monitor **stack events**          | Real-time feedback during rollback |
| Use **Disable Rollback** in dev/test     | Easier debugging                   |
| Use **Change Sets** before updates       | Avoid surprises during update      |
| Protect critical resources w/ policies   | But monitor rollback failure risks |
| Monitor **CloudTrail** + CloudWatch Logs | For root cause of rollback errors  |
| Enable **termination protection**        | Prevent accidental deletions       |

---

## ğŸ“ Summary

| Exam Concept                      | What to Remember                                       |
| --------------------------------- | ------------------------------------------------------ |
| Rollback on **creation failure**  | Deletes all resources by default                       |
| Rollback on **update failure**    | Reverts to last known good state                       |
| `UPDATE_ROLLBACK_FAILED` state    | Fix manually â†’ call `continue-update-rollback`         |
| `--disable-rollback`              | Lets you inspect failed stack instead of auto-deleting |
| Nested stack failure              | Causes parent rollback unless configured otherwise     |
| Stack policies can block rollback | Remove them temporarily if needed                      |
