# **ğŸ›¡ï¸ AWS CloudFormation Stack Role**

## **ğŸ“Œ Introduction**

By default, when a user creates or updates a CloudFormation stack, **the stack operates with the IAM permissions of the user who initiated the request**. This means that if a user lacks the necessary IAM permissions, CloudFormation **fails to deploy resources**.

To solve this, **AWS CloudFormation Stack Roles** allow CloudFormation to assume an IAM role with **predefined permissions**, ensuring:

- âœ… **Users can deploy stacks without requiring extensive IAM permissions.**
- âœ… **CloudFormation has only the permissions it needs to manage stack resources.**
- âœ… **Enhanced security and compliance by limiting direct user privileges.**

---

<div style="text-align: center;">
    <img src="images/cfn-stack-role-diagram.png" style="border-radius: 10px; width: 80%;" alt="cfn-stack-role-diagram">
</div>

---

<div style="text-align: center;">
  <img src="images/cfn-stack-role.png" style="border-radius: 10px; width: 80%;" alt="cfn-stack-role">
</div>

---

## **ğŸ”– Why Do We Need a Stack Role?**

| **Scenario**                        | **Why a Stack Role is Needed?**                                     |
| ----------------------------------- | ------------------------------------------------------------------- |
| **User has limited permissions**    | Allows stack deployment using an IAM role with broader permissions. |
| **Multiple teams deploying stacks** | Ensures consistency in permissions across environments.             |
| **Compliance and governance**       | Restricts unauthorized changes to sensitive resources.              |
| **Separation of duties**            | Developers can deploy stacks without having direct IAM permissions. |

---

## **ğŸ”– How Stack Role Works in AWS CloudFormation**

1ï¸âƒ£ **User initiates a CloudFormation stack operation** (create, update, delete).  
2ï¸âƒ£ **CloudFormation assumes the IAM Role specified as the Stack Role.**  
3ï¸âƒ£ **CloudFormation uses the roleâ€™s permissions** to provision or modify AWS resources.

```mermaid
sequenceDiagram
autonumber
participant Admin as Administrator
participant Developer as Developer
participant CloudFormation as AWS CloudFormation
participant IAMRole as Stack Role (IAM)
Admin->>IAMRole: 1ï¸âƒ£ Create Stack Role with Required Permissions
Developer->>CloudFormation: 2ï¸âƒ£ Create/Update/Delete Stack
CloudFormation->>IAMRole: 3ï¸âƒ£ Assume Role for Execution
IAMRole->>CloudFormation: âœ… Temporary Permissions Granted
CloudFormation->>AWSResources: 4ï¸âƒ£ Deploy Resources Using Role
```

âœ… **Ensures CloudFormation operates with controlled permissions, reducing security risks.**

---

## **ğŸ”– Setting Up a Stack Role for Developers**

### **ğŸ› ï¸ Step 1: Administrator Creates the Stack Role**

#### **Create an IAM Role for CloudFormation Execution**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "cloudformation.amazonaws.com"
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

> ğŸ“Œ User must have `iam:PassRole` permissions

âœ” **Allows CloudFormation to assume this role.**

#### **Attach Permissions for CloudFormation Execution**

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["ec2:CreateInstance", "s3:CreateBucket", "iam:PassRole"],
      "Resource": "*"
    }
  ]
}
```

âœ” **Grants permissions to CloudFormation to create AWS resources.**

---

### **ğŸ› ï¸ Step 2: Developer Uses the Stack Role for Deployment**

#### **Developerâ€™s IAM Policy** (Minimal Permissions)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": ["cloudformation:CreateStack", "cloudformation:UpdateStack", "cloudformation:DeleteStack"],
      "Resource": "*"
    }
  ]
}
```

âœ” **Developer can manage CloudFormation stacks but not directly access AWS resources.**

---

## **ğŸ”– How a Developer Uses a Stack Role in AWS CLI**

### **ğŸ› ï¸ Create a Stack with a Specific Role**

```sh
aws cloudformation create-stack --stack-name MySecureStack \
  --template-body file://template.yaml \
  --role-arn arn:aws:iam::123456789012:role/MyCloudFormationRole
```

âœ” **Ensures CloudFormation assumes the correct IAM Role for stack execution.**

---

### **ğŸ› ï¸ Updating a Stack with a Specific Role**

```sh
aws cloudformation update-stack --stack-name MySecureStack \
  --template-body file://template.yaml \
  --role-arn arn:aws:iam::123456789012:role/MyCloudFormationRole
```

âœ” **Ensures updates are performed with controlled permissions.**

---

## **ğŸ”– Using a Stack Role in Nested Stacks**

When deploying **nested stacks**, the **parent stack role must have permissions to pass roles** to child stacks. Use the `RoleARN` property in the nested stack definition:

### **ğŸ› ï¸ Example: Assigning a Role to a Nested Stack**

```yaml
Resources:
  ParentStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      StackName: "ParentStack"
      TemplateURL: "https://s3.amazonaws.com/mybucket/parent-template.yaml"
      RoleARN: "arn:aws:iam::123456789012:role/MyCloudFormationRole"

  NestedStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      StackName: "NestedStack"
      TemplateURL: "https://s3.amazonaws.com/mybucket/nested-template.yaml"
      RoleARN: "arn:aws:iam::123456789012:role/MyCloudFormationRole"
```

âœ” **Ensures both parent and nested stacks use the same IAM Role for execution.**

---

## **ğŸ”– Best Practices for Using Stack Roles**

âœ… **Use IAM Least Privilege Model**

- Grant CloudFormation only the permissions it needs.  
  âœ… **Restrict Role Usage to CloudFormation Service**
- Prevent unintended use of the role by other AWS services.  
  âœ… **Monitor Role Assumption with AWS CloudTrail**
- Track who and when CloudFormation assumes the role.  
  âœ… **Use Service Control Policies (SCPs) in AWS Organizations**
- Prevent users from overriding stack roles manually.

---

## **âœ… Conclusion**

AWS CloudFormation **Stack Roles** provide a secure, controlled way to deploy AWS resources by **delegating permissions to an IAM role** rather than relying on user credentials.

âœ” **Ensures security by limiting direct user access.**  
âœ” **Facilitates compliance and governance.**  
âœ” **Prevents privilege escalation and misconfigurations.**

ğŸ’¡ **Using Stack Roles effectively enhances security and control over AWS deployments!** ğŸš€
