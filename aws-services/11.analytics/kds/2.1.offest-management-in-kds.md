# ğŸ«´ **What Happens If a KDS Consumer Fails During Processing?**

> _If a consumer reads a record from Kinesis and **crashes or fails** before completing the task â€” will the record be lost or retried?_ Letâ€™s break it down.

---

## ğŸ¯ **KDS Doesnâ€™t Manage Offsets â€” You Do**

Unlike SQS or DynamoDB Streams, **Kinesis Data Streams does not track which records have been â€œprocessed.â€**

Instead, it follows a **pull-based model**, and your **consumer application is responsible for managing checkpointing** (where you last successfully read and processed).

> ğŸ“Œ Thereâ€™s no concept of â€œshiftingâ€ like in Kafka â€” the record is **always available** until the **retention window expires** (default: 24 hours, up to 365 days).

---

## ğŸ’¥ **What If a Consumer Crashes After Reading a Record?**

Letâ€™s say a consumer retrieves a record, starts processing it, and **fails before finishing**.

### ğŸ¤” Will the record be reprocessed?

âœ… **Yes**, because:

- The record is still in the stream.
- The consumer **never checkpointed** that it finished processing.
- On restart, the consumer **resumes from the last checkpoint** â†’ which includes the unprocessed record.

---

## âœ… **Checkpointing = Responsibility of the Consumer**

### When do you checkpoint?

- After **successful processing** of a record or batch.
- If the app crashes **before checkpointing**, the same record will be read again.

> ğŸ§  AWS SDKs like the **Kinesis Client Library (KCL)** handle checkpointing **via DynamoDB**.

---

## ğŸ“Š **Workflow: Record Fetched but App Crashes Before Checkpoint**

```mermaid
sequenceDiagram
    participant KDS as Kinesis Shard
    participant Consumer as Application
    participant DynamoDB as Checkpoint Store

    KDS-->>Consumer: Send Record-123
    Consumer-->>Consumer: Start processing Record-123
    Consumer--X KDS: ğŸ’¥ App crashes before checkpoint
    Note right of DynamoDB: No checkpoint updated

    Consumer->>KDS: Restart and re-pull from last checkpoint
    KDS-->>Consumer: Send Record-123 again (retries)
```

---

## ğŸ” **Kinesis = At-Least-Once Delivery**

- **Records are not deleted** once read.
- You get **at-least-once delivery**.
- You must **design your consumer to be idempotent** (processing same record twice shouldn't break your system).

---

## ğŸ”’ **Best Practices for Failure Resilience**

| Strategy                         | Why It Helps                                             |
| -------------------------------- | -------------------------------------------------------- |
| âœ… Checkpoint **after** success  | Prevents premature advancement                           |
| ğŸ’¡ Idempotent consumers          | Ensure double-processing has no side effects             |
| ğŸ›  Use **KCL / Lambda**           | AWS handles checkpointing and retries automatically      |
| ğŸ§ª Monitor w/ CloudWatch metrics | Catch processing errors and retry trends                 |
| ğŸ—“ Tune stream retention          | Keep records longer (24hâ€“365d) to allow replay if needed |

---

## âœ… Summary

| Concept                       | Behavior                                                            |
| ----------------------------- | ------------------------------------------------------------------- |
| Record lost if consumer dies? | âŒ No â€” still in stream                                             |
| Is offset auto-managed?       | âŒ No â€” consumer manages checkpoint                                 |
| What happens on restart?      | âœ… Consumer re-reads from last checkpoint (retries unfinished data) |
| Safe from duplication?        | âš ï¸ Only if **you design your logic to be idempotent**               |
