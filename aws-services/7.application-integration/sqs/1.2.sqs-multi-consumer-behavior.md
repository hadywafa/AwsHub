# ğŸ“¬ **Multi-Consumer Behavior in Amazon SQS**

Unlike Kinesis or Kafka, **Amazon SQS does not support multiple consumers reading the _same_ message**. It follows a **message consumption model** where each message is **delivered only once** to **one consumer**, even when multiple consumers are polling concurrently.

Letâ€™s explore **how SQS handles message processing, visibility, ordering, and isolation** â€” and how FIFO queues provide ordering guarantees.

---

## ğŸ¯ **Scenario: E-Commerce Notifications & Order Processing**

Imagine an online store with two independent systems consuming messages from an SQS queue:

- 1ï¸âƒ£ **Inventory System** ğŸ· â†’ Updates stock when orders are placed
- 2ï¸âƒ£ **Notification System** ğŸ“¢ â†’ Sends emails/SMS to users

---

### ğŸŸ© **With a Standard SQS Queue: Parallel but No Ordering**

<div align="center">

| Timestamp | Order ID | Action     |
| --------- | -------- | ---------- |
| `T1`      | `A1`     | âœ… Placed  |
| `T2`      | `A2`     | âœ… Placed  |
| `T3`      | `A1`     | ğŸ“¦ Shipped |
| `T4`      | `A2`     | ğŸ“¦ Shipped |

</div>

---

ğŸ” These messages are **not guaranteed to be delivered in order**, and **may be duplicated**. However, **multiple consumers** can process them in **parallel**.

---

<div align="center">

```mermaid
sequenceDiagram
    participant Producer as ğŸ“¦ Order Producer
    participant SQS as ğŸ“¨ SQS Standard Queue
    participant Inventory as ğŸ› ï¸ Inventory System (Consumer-1)
    participant Notification as ğŸ“¬ Notification System (Consumer-2)

    Producer->>SQS: âœ… Order A1 Placed
    Producer->>SQS: âœ… Order A2 Placed
    Producer->>SQS: ğŸ“¦ Order A1 Shipped
    Producer->>SQS: ğŸ“¦ Order A2 Shipped

    SQS-->>Inventory: âœ… Order A1 Placed
    SQS-->>Notification: ğŸ“¦ Order A2 Shipped
    SQS-->>Inventory: ğŸ“¦ Order A1 Shipped
    SQS-->>Notification: âœ… Order A2 Placed
```

</div>

---

## ğŸ§© **Key Behavior: SQS Standard Queue**

| Behavior           | Standard Queue                                                                                            |
| ------------------ | --------------------------------------------------------------------------------------------------------- |
| Message Visibility | After one consumer retrieves a message, it is **invisible** to others until it is processed or times out. |
| Duplicate Messages | Possible. Apps must be **idempotent**.                                                                    |
| Order Guarantee    | âŒ No. Messages may be out of order.                                                                      |
| Parallelism        | âœ… High. Multiple consumers process in parallel.                                                          |
| Isolation          | âœ… Each message goes to only **one** consumer.                                                            |
| Re-processing      | âœ… Automatic if the consumer fails or times out.                                                          |

---

## ğŸ”¢ **With FIFO Queue: Group-Based Ordered Parallelism**

<div align="center">

| Timestamp | Group (Customer) | Status       |
| --------- | ---------------- | ------------ |
| `T1`      | `User-A`         | âœ… Placed    |
| `T2`      | `User-B`         | âœ… Placed    |
| `T3`      | `User-A`         | ğŸšš Shipped   |
| `T4`      | `User-B`         | ğŸšš Shipped   |
| `T5`      | `User-A`         | ğŸ“¦ Delivered |

</div>

---

ğŸ“Œ Here, each `MessageGroupId` (e.g., `User-A`) acts like a **shard** or **partition** â€” messages in the same group are **delivered in order**, and **only one consumer** can process a group at a time.

---

<div align="center">

```mermaid
sequenceDiagram
    participant Producer as ğŸ›’ Order Producer
    participant FIFO as ğŸ” FIFO Queue
    participant Consumer1 as ğŸ§‘â€ğŸ’» Consumer 1
    participant Consumer2 as ğŸ§‘â€ğŸ’» Consumer 2

    Producer->>FIFO: âœ… Placed (User-A)
    Producer->>FIFO: âœ… Placed (User-B)
    Producer->>FIFO: ğŸšš Shipped (User-A)
    Producer->>FIFO: ğŸšš Shipped (User-B)
    Producer->>FIFO: ğŸ“¦ Delivered (User-A)

    FIFO-->>Consumer1: âœ… Placed (User-A)
    FIFO-->>Consumer2: âœ… Placed (User-B)
    FIFO-->>Consumer1: ğŸšš Shipped (User-A)
    FIFO-->>Consumer2: ğŸšš Shipped (User-B)
    FIFO-->>Consumer1: ğŸ“¦ Delivered (User-A)
```

</div>

---

---

## âš™ï¸ **SQS Message Isolation Mechanisms**

| Mechanism                 | Purpose                                              |
| ------------------------- | ---------------------------------------------------- |
| â³ **Visibility Timeout** | Ensures messages are â€œlockedâ€ while being processed. |
| ğŸ§º **Dead Letter Queue**  | Captures failed messages after X retries.            |
| ğŸ§¾ **Message Retention**  | Stores messages for up to 14 days.                   |
| ğŸ§ª **Deduplication ID**   | Ensures exactly-once delivery in FIFO queues.        |

---

## ğŸ” **Why SQS Doesn't Do Multi-Consumer Fan-Out (Like Kinesis)**

| Concept            | SQS                             | Kinesis                      |
| ------------------ | ------------------------------- | ---------------------------- |
| 1 Message â†’ N Apps | âŒ No (1 message, 1 consumer)   | âœ… Yes (fan-out per shard)   |
| Record Replay      | âŒ No (once deleted, itâ€™s gone) | âœ… Yes (via checkpointing)   |
| Use Case           | Task queue / job processing     | Event processing / analytics |
| Ordering           | FIFO (group-based)              | Shard-based                  |

---

## ğŸ§  **When to Use SQS (vs. Kinesis)**

| Use Case                        | Use SQS                          | Use Kinesis                       |
| ------------------------------- | -------------------------------- | --------------------------------- |
| Work distribution               | âœ… Yes                           | ğŸš« No                             |
| Message fan-out (1 â†’ many apps) | ğŸš« Use SNS or EventBridge        | âœ… Built-in fan-out via consumers |
| Event replay                    | ğŸš« No (unless DLQ used manually) | âœ… Replay from stream (24hâ€“365d)  |
| Throughput-critical pipeline    | âœ… Standard SQS                  | âœ… Kinesis with parallel shards   |
| Strict order                    | âœ… FIFO Queue                    | âœ… Per shard                      |
| Stream analytics (e.g., logs)   | ğŸš« Not designed for this         | âœ… Yes                            |

---

## âœ… Final Takeaways

- **SQS is not for broadcasting messages to multiple consumers** â€” it delivers **only once per message**.
- **Standard queues** maximize throughput, while **FIFO queues** provide reliable, in-order processing **per group**.
- If you need **shared reads** or **replay**, choose **Kinesis Data Streams** instead.
