# ğŸ§  **Creating EC2 AMIs: AWS Backup vs. EventBridge + Lambda**

> _Not all backups are equal â€” especially when it comes to ensuring file system integrity._
> Letâ€™s explore how **AWS Backup** and **EventBridge-triggered Lambda** differ when used for **automated AMI creation**.

---

## ğŸ“¦ **Option 1: AMI Creation via AWS Backup â€“ No Reboot**

### ğŸ”¹ Flow

<div style="text-align: center;">
  <img src="images/aws-backup-no-reboot.png" alt="Backup No Reboot" style="border-radius: 10px; width: 80%;" />
</div>

### âœ… What Happens

- AWS Backup creates an **EBS snapshot** of the root volume
- This snapshot is used to generate an **AMI**
- **The EC2 instance remains running** (no interruption)

### âš ï¸ Key Caveat

- âš ï¸ **No reboot** â†’ **OS buffers may not be flushed to disk**
- â— Result: AMI may not **fully reflect a consistent state**

> Use this only for **non-critical systems** or **quick testing environments**.

---

## â° **Option 2: EventBridge + Lambda â€“ With Reboot**

### ğŸ”¹ Flow

<div style="text-align: center;">
  <img src="images/aws-backup-with-reboot.png" alt="EventBridge AMI with Reboot" style="border-radius: 10px; width: 80%;" />
</div>

### ğŸ” Process

1. **EventBridge Rule** triggers Lambda on a schedule
2. Lambda calls `create-image` EC2 API with `--reboot`
3. EC2 instance is rebooted to flush memory
4. AMI is created from the clean, consistent snapshot

### âœ… Pros

- Ensures **filesystem integrity** (ideal for prod)
- Automatable via **cron-style EventBridge rule**

### Example CLI

```bash
aws ec2 create-image \
  --instance-id i-1234567890abcdef0 \
  --name "MyApp-AMI-$(date +%Y-%m-%d)" \
  --reboot
```

---

## ğŸ§¬ Sequence Diagram Comparison

### ğŸ“¤ Backup Plan (No Reboot)

<div align="center">

```mermaid
sequenceDiagram
    participant ğŸŸ¢ AWS Backup
    participant ğŸŸ  EC2
    participant ğŸ“¸ AMI

    ğŸŸ¢ AWS Backup->>ğŸŸ  EC2: Snapshot volume (no reboot)
    ğŸŸ¢ AWS Backup->>ğŸ“¸ AMI: Create from snapshot
    Note right of ğŸ“¸ AMI: Fast but no file consistency
```

</div>

### â° EventBridge + Lambda (With Reboot)

<div align="center">

```mermaid
sequenceDiagram
    participant â° EventBridge
    participant ğŸ§  Lambda
    participant ğŸŸ  EC2
    participant ğŸ“¸ AMI

    â° EventBridge->>ğŸ§  Lambda: Trigger on schedule
    ğŸ§  Lambda->>ğŸŸ  EC2: Reboot and create AMI
    ğŸŸ  EC2->>ğŸ“¸ AMI: Flush buffers â†’ Snapshot â†’ AMI
    Note right of ğŸ“¸ AMI: Safe and production-ready
```

</div>

---

## ğŸ“Œ Summary

| Feature                | AWS Backup (No Reboot)   | EventBridge + Lambda (Reboot)        |
| ---------------------- | ------------------------ | ------------------------------------ |
| ğŸ” Instance rebooted   | âŒ No                    | âœ… Yes                               |
| ğŸ§¹ File system flushed | âŒ Risk of inconsistency | âœ… Guaranteed integrity              |
| âš™ï¸ Custom logic        | âŒ No control            | âœ… Full automation via Lambda        |
| ğŸ“† Scheduling          | âœ… Backup plans          | âœ… EventBridge rule                  |
| âœ… Use Case            | Dev/test backups         | Production-safe, clean image backups |

---

## âœ… Best Practices

- For **dev/test instances** â†’ AWS Backup is simple and cost-efficient
- For **production-critical** systems â†’ use **EventBridge + Lambda** with `--reboot`
- Always tag AMIs with `CreatedBy=Automation`, `Source=EC2-ID`, `Safe=True/False`
- Consider using **Amazon Data Lifecycle Manager (DLM)** if you want **native AMI rotation**
