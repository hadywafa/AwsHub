# ğŸ›¡ï¸ **EBS Encryption & Decryption: How It Works Behind the Scenes**

Amazon **Elastic Block Store (EBS)** provides durable storage volumes that can be encrypted **at rest and in transit** â€” all **managed by AWS Key Management Service (KMS)**.

Letâ€™s break down the **two main flows**:

- ğŸ” Encryption flow (when **writing data** to the volume)
- ğŸ”“ Decryption flow (when **reading data** from the volume)

---

## ğŸ” **1. Updated Encryption Flow (Write Path)**

<div align="center">

```mermaid
sequenceDiagram
    participant EC2 as EC2 Instance ğŸ’»
    participant EBS as Amazon EBS ğŸ’½
    participant HEM as Host Encryption Module ğŸ§ 
    participant KMS as AWS KMS ğŸ”‘
    participant HSM as AWS HSM ğŸ”’

    EC2->>EBS: Write request ("Launch codes") ğŸ“¤
    EBS->>HEM: Forward to Host Encryption Module
    HEM->>KMS: Request DEK for encryption ğŸ”‘
    KMS->>HSM: Generate new DEK (using CMK)
    HSM-->>KMS: Return Plaintext DEK + Encrypted DEK ğŸ›¡ï¸ğŸ—ï¸
    KMS-->>HEM: Return both DEKs
    HEM->>EBS: Save encrypted DEK (metadata)
    HEM->>HEM: Encrypt data using plaintext DEK ğŸ”’
    HEM->>EBS: Store encrypted data ğŸ’½
```

</div>

---

### ğŸ§  Step-by-Step Breakdown

1ï¸âƒ£ **Write Request Begins**
EC2 sends data to write to EBS.

2ï¸âƒ£ **EBS Hands Data to HEM**
The host-level module intercepts the write.

3ï¸âƒ£ **HEM Requests a DEK**
It asks KMS to generate a **new DEK** for this volume.

4ï¸âƒ£ **KMS via HSM Generates Keys**
The **HSM** produces:

- A **Plaintext DEK** for encryption
- An **Encrypted DEK**, wrapped with your CMK

5ï¸âƒ£ **KMS Returns Both Keys**
HEM receives both versions.

6ï¸âƒ£ **Encrypted DEK Is Stored**
Encrypted DEK is stored as **volume metadata** with EBS.

7ï¸âƒ£ **Plaintext DEK Is Used in Memory**
HEM encrypts your data **in RAM only**, never storing plaintext keys.

8ï¸âƒ£ **Encrypted Data Is Saved**
The encrypted block is stored in the volume. âœ…

---

## ğŸ”“ **2. Updated Decryption Flow (Read Path)**

<div align="center">

```mermaid
sequenceDiagram
    participant EC2 as EC2 Instance ğŸ’»
    participant EBS as Amazon EBS ğŸ’½
    participant HEM as Host Encryption Module ğŸ§ 
    participant KMS as AWS KMS ğŸ”‘
    participant HSM as AWS HSM ğŸ”’

    EC2->>EBS: Read request ğŸ“¥
    EBS->>HEM: Send encrypted block + encrypted DEK
    HEM->>HEM: Check DEK cache (RAM) ğŸ”
    alt DEK Cached
        HEM->>HEM: Use cached DEK to decrypt block ğŸ”“
    else DEK Not Cached
        HEM->>KMS: Send encrypted DEK to decrypt ğŸ”‘
        KMS->>HSM: Decrypt DEK using CMK
        HSM-->>KMS: Plaintext DEK ğŸ—ï¸
        KMS-->>HEM: Send decrypted DEK
        HEM->>HEM: Decrypt block using DEK ğŸ”“
    end
    HEM-->>EC2: Return plaintext data ğŸ“„
```

</div>

---

### ğŸ§  Step-by-Step Breakdown

1ï¸âƒ£ **EC2 Requests Read**
App on EC2 reads a file or data block.

2ï¸âƒ£ **EBS Sends Encrypted Block**
Along with the **encrypted DEK**, stored during write.

3ï¸âƒ£ **HEM Checks for Cached DEK**
It checks if the **plaintext DEK is still in memory**.

4ï¸âƒ£ **If Cached âœ Fast Decrypt**
Data block is decrypted instantly using cached DEK.

5ï¸âƒ£ **If Not Cached âœ Fetch from KMS**
HEM sends the **encrypted DEK** to KMS.

6ï¸âƒ£ **KMS Uses HSM to Decrypt It**
Plaintext DEK is returned securely to HEM (RAM only).

7ï¸âƒ£ **HEM Decrypts the Block**
Encrypted block is decrypted using the DEK.

8ï¸âƒ£ **Plaintext Sent to EC2**
Application gets its data, unaware of the magic behind it.

---

## ğŸ§© Summary: Important Facts

| ğŸ’¡ Concept                  | ğŸ” Encryption                 | ğŸ”“ Decryption                      |
| --------------------------- | ----------------------------- | ---------------------------------- |
| DEK generated by            | KMS + HSM                     | N/A (retrieved and decrypted)      |
| Keys returned               | Plaintext DEK + Encrypted DEK | Plaintext DEK (from encrypted DEK) |
| Encrypted DEK stored where? | With EBS metadata             | With EBS metadata                  |
| Plaintext DEK lifetime      | RAM only, short-lived         | RAM only, may be cached            |
| Can DEK be reused?          | Yes, until flushed            | Yes, if in RAM cache               |
| CMK visibility              | âŒ Never exposed              | âŒ Never exposed                   |

## âœ¨ Real-World Analogy

ğŸ” **Encryption = Sealing a Secret Letter**

- You (EC2) want to store a letter.
- The host encryption module is your **mailroom guy with a shredder and safe**.
- He calls AWS KMS to **get a vault key** (DEK) locked inside a box (encrypted under CMK).
- He opens the box **in memory**, encrypts your letter, locks it in a safe (EBS), and discards the key copy.

ğŸ”“ **Decryption = Opening the Safe**

- When you need the letter back, he retrieves it from the safe, unlocks the vault key again, opens the letter, and hands it to you.
- You never see the key or safe â€” just your letter.

---

## âœ… Benefits of This Design

- **Zero Touch**: All this encryption/decryption is transparent to your application.
- **Key Rotation**: You can rotate your CMK in KMS; AWS re-encrypts new data automatically.
- **Compliance**: Meets standards like PCI DSS, HIPAA, GDPR, etc.
- **No Performance Tradeoff**: Encryption is optimized â€” you donâ€™t take a big performance hit.
