# 🛡️ **EBS Encryption & Decryption: How It Works Behind the Scenes**

Amazon **Elastic Block Store (EBS)** provides durable storage volumes that can be encrypted **at rest and in transit** — all **managed by AWS Key Management Service (KMS)**.

Let’s break down the **two main flows**:

- 🔐 Encryption flow (when **writing data** to the volume)
- 🔓 Decryption flow (when **reading data** from the volume)

---

## 🔐 **1. Updated Encryption Flow (Write Path)**

<div align="center">

```mermaid
sequenceDiagram
    participant EC2 as EC2 Instance 💻
    participant EBS as Amazon EBS 💽
    participant HEM as Host Encryption Module 🧠
    participant KMS as AWS KMS 🔑
    participant HSM as AWS HSM 🔒

    EC2->>EBS: Write request ("Launch codes") 📤
    EBS->>HEM: Forward to Host Encryption Module
    HEM->>KMS: Request DEK for encryption 🔑
    KMS->>HSM: Generate new DEK (using CMK)
    HSM-->>KMS: Return Plaintext DEK + Encrypted DEK 🛡️🗝️
    KMS-->>HEM: Return both DEKs
    HEM->>EBS: Save encrypted DEK (metadata)
    HEM->>HEM: Encrypt data using plaintext DEK 🔒
    HEM->>EBS: Store encrypted data 💽
```

</div>

---

### 🧠 Step-by-Step Breakdown

1️⃣ **Write Request Begins**
EC2 sends data to write to EBS.

2️⃣ **EBS Hands Data to HEM**
The host-level module intercepts the write.

3️⃣ **HEM Requests a DEK**
It asks KMS to generate a **new DEK** for this volume.

4️⃣ **KMS via HSM Generates Keys**
The **HSM** produces:

- A **Plaintext DEK** for encryption
- An **Encrypted DEK**, wrapped with your CMK

5️⃣ **KMS Returns Both Keys**
HEM receives both versions.

6️⃣ **Encrypted DEK Is Stored**
Encrypted DEK is stored as **volume metadata** with EBS.

7️⃣ **Plaintext DEK Is Used in Memory**
HEM encrypts your data **in RAM only**, never storing plaintext keys.

8️⃣ **Encrypted Data Is Saved**
The encrypted block is stored in the volume. ✅

---

## 🔓 **2. Updated Decryption Flow (Read Path)**

<div align="center">

```mermaid
sequenceDiagram
    participant EC2 as EC2 Instance 💻
    participant EBS as Amazon EBS 💽
    participant HEM as Host Encryption Module 🧠
    participant KMS as AWS KMS 🔑
    participant HSM as AWS HSM 🔒

    EC2->>EBS: Read request 📥
    EBS->>HEM: Send encrypted block + encrypted DEK
    HEM->>HEM: Check DEK cache (RAM) 🔁
    alt DEK Cached
        HEM->>HEM: Use cached DEK to decrypt block 🔓
    else DEK Not Cached
        HEM->>KMS: Send encrypted DEK to decrypt 🔑
        KMS->>HSM: Decrypt DEK using CMK
        HSM-->>KMS: Plaintext DEK 🗝️
        KMS-->>HEM: Send decrypted DEK
        HEM->>HEM: Decrypt block using DEK 🔓
    end
    HEM-->>EC2: Return plaintext data 📄
```

</div>

---

### 🧠 Step-by-Step Breakdown

1️⃣ **EC2 Requests Read**
App on EC2 reads a file or data block.

2️⃣ **EBS Sends Encrypted Block**
Along with the **encrypted DEK**, stored during write.

3️⃣ **HEM Checks for Cached DEK**
It checks if the **plaintext DEK is still in memory**.

4️⃣ **If Cached ➜ Fast Decrypt**
Data block is decrypted instantly using cached DEK.

5️⃣ **If Not Cached ➜ Fetch from KMS**
HEM sends the **encrypted DEK** to KMS.

6️⃣ **KMS Uses HSM to Decrypt It**
Plaintext DEK is returned securely to HEM (RAM only).

7️⃣ **HEM Decrypts the Block**
Encrypted block is decrypted using the DEK.

8️⃣ **Plaintext Sent to EC2**
Application gets its data, unaware of the magic behind it.

---

## 🧩 Summary: Important Facts

| 💡 Concept                  | 🔐 Encryption                 | 🔓 Decryption                      |
| --------------------------- | ----------------------------- | ---------------------------------- |
| DEK generated by            | KMS + HSM                     | N/A (retrieved and decrypted)      |
| Keys returned               | Plaintext DEK + Encrypted DEK | Plaintext DEK (from encrypted DEK) |
| Encrypted DEK stored where? | With EBS metadata             | With EBS metadata                  |
| Plaintext DEK lifetime      | RAM only, short-lived         | RAM only, may be cached            |
| Can DEK be reused?          | Yes, until flushed            | Yes, if in RAM cache               |
| CMK visibility              | ❌ Never exposed              | ❌ Never exposed                   |

## ✨ Real-World Analogy

🔐 **Encryption = Sealing a Secret Letter**

- You (EC2) want to store a letter.
- The host encryption module is your **mailroom guy with a shredder and safe**.
- He calls AWS KMS to **get a vault key** (DEK) locked inside a box (encrypted under CMK).
- He opens the box **in memory**, encrypts your letter, locks it in a safe (EBS), and discards the key copy.

🔓 **Decryption = Opening the Safe**

- When you need the letter back, he retrieves it from the safe, unlocks the vault key again, opens the letter, and hands it to you.
- You never see the key or safe — just your letter.

---

## ✅ Benefits of This Design

- **Zero Touch**: All this encryption/decryption is transparent to your application.
- **Key Rotation**: You can rotate your CMK in KMS; AWS re-encrypts new data automatically.
- **Compliance**: Meets standards like PCI DSS, HIPAA, GDPR, etc.
- **No Performance Tradeoff**: Encryption is optimized — you don’t take a big performance hit.
