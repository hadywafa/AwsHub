# ğŸŒ **Customization at the Edge with CloudFront Functions & Lambda\@Edge**

Modern applications demand **low latency**, **dynamic personalization**, and **security enforcement** â€” all before reaching the origin. **Edge computing** lets you run logic **close to your users**, right at AWSâ€™s **CloudFront edge locations**.

AWS offers two serverless tools to do this:

- âš¡ **CloudFront Functions** (lightweight JS for high-scale)
- ğŸ§  **Lambda\@Edge** (full Lambda power at the edge)

---

<div style="text-align: center;">
  <img src="images/cloud-front-with-lambda-at-edge.png" alt="CloudFront with Lambda@Edge" style="border-radius: 10px; width: 60%;" />
</div>

---

## ğŸ§± **How Edge Customization Works**

> You write code (JavaScript or Node/Python) and **attach it to CloudFront events** like Viewer Request or Origin Response. CloudFront executes this logic across its **globally distributed POPs (Points of Presence)**.

**4 Integration Points (CloudFront Triggers):**

- ğŸ“© Viewer Request
- ğŸ“¤ Viewer Response
- ğŸ›« Origin Request
- ğŸ›¬ Origin Response

---

## âš¡ CloudFront Functions vs. Lambda\@Edge (Comparison Table)

| Feature             | **CloudFront Functions**            | **Lambda\@Edge**                  |
| ------------------- | ----------------------------------- | --------------------------------- |
| Language            | JavaScript                          | Node.js, Python                   |
| Scale               | Millions of req/sec                 | Thousands of req/sec              |
| Triggers Supported  | Viewer Request/Response             | Viewer + Origin Req/Res           |
| Execution Time      | < 1 ms                              | 5â€“10 sec                          |
| Memory              | 2 MB                                | 128 MB â€“ 10 GB                    |
| Network Access      | âŒ No                               | âœ… Yes                            |
| Request Body Access | âŒ No                               | âœ… Yes                            |
| Pricing             | âœ… Cheaper (1/6th cost) + free tier | ğŸ’° Charged per request + duration |

---

## âœ… **Common Use Cases for Edge Customization**

| Category                 | CloudFront Functions                          | Lambda\@Edge                                     |
| ------------------------ | --------------------------------------------- | ------------------------------------------------ |
| ğŸ” Security & Access     | Header rewriting, JWT check                   | OAuth, JWT validation with external API          |
| ğŸš¦ Routing               | Redirects, A/B testing, static URL rewrites   | Intelligent origin routing, language-based split |
| ğŸ“¦ Caching & Performance | Cache key normalization                       | Modify cache behavior per-user                   |
| ğŸ¨ SEO & UX Enhancements | Inject SEO-friendly headers                   | Dynamic personalization from S3/DB               |
| ğŸ§ª Testing               | Region or user-agent-based variation delivery | Cookie/session-based A/B testing                 |
| ğŸ“ˆ Analytics & Tracking  | Add tracking headers/cookies                  | User behavior recording into backend             |

---

## âœï¸ **Example 1: CloudFront Function â€“ Normalize URL Case**

```js
function handler(event) {
  var request = event.request;
  request.uri = request.uri.toLowerCase();
  return request;
}
```

âœ… Applied on: **Viewer Request**

ğŸ§  Use case: Normalize URLs like `/HOME` â†’ `/home` to improve cache hit rate

---

## âœï¸ **Example 2: Lambda\@Edge â€“ Redirect Based on Country**

```js
"use strict";
exports.handler = async (event) => {
  const request = event.Records[0].cf.request;
  const country = event.Records[0].cf.headers["cloudfront-viewer-country"][0].value;

  if (country === "DE") {
    return {
      status: "302",
      statusDescription: "Found",
      headers: {
        location: [{ value: "https://de.example.com" }],
      },
    };
  }
  return request;
};
```

âœ… Applied on: **Viewer Request**

ğŸ§  Use case: **Geo-based redirection** (Germany â†’ localized site)

---

## ğŸ” **Triggers Recap (When the Code Executes)**

| Trigger Name    | CloudFront Functions | Lambda\@Edge | When It Happens                                |
| --------------- | -------------------- | ------------ | ---------------------------------------------- |
| Viewer Request  | âœ… Yes               | âœ… Yes       | Just after client sends request to CloudFront  |
| Viewer Response | âœ… Yes               | âœ… Yes       | Before CloudFront sends response to client     |
| Origin Request  | âŒ No                | âœ… Yes       | Before CloudFront forwards to the origin       |
| Origin Response | âŒ No                | âœ… Yes       | After CloudFront receives response from origin |

---

## ğŸ§  Choosing the Right Tool

| Use This If...                                            | Use...                      |
| --------------------------------------------------------- | --------------------------- |
| You need ultra-fast header/url rewrites                   | âœ… **CloudFront Functions** |
| You want access to body, file system, or external network | âœ… **Lambda\@Edge**         |
| You're doing lightweight cache tuning or simple auth      | âœ… **CloudFront Functions** |
| You need advanced personalization or origin logic         | âœ… **Lambda\@Edge**         |
| You want to minimize cost and run at huge scale           | âœ… **CloudFront Functions** |

---

## ğŸ’¡ Final Summary

| ğŸ§© Feature    | **CloudFront Functions**    | **Lambda\@Edge**                      |
| ------------- | --------------------------- | ------------------------------------- |
| ğŸ” Triggers   | Viewer Req/Res              | All 4 (Viewer + Origin Req/Res)       |
| âš™ï¸ Complexity | Lightweight logic           | Heavy logic, file/network access      |
| ğŸ’° Cost       | Low + Free Tier             | Higher cost, pay per duration         |
| ğŸ§ª Best For   | Auth, cache keys, redirects | Dynamic personalization, integrations |

---

> âœ… CloudFront Functions = ğŸ”¥ For fast, cheap, lightweight edge logic
> âœ… Lambda\@Edge = ğŸ§  For complex, powerful processing at the edge
